<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sticker – Landscape</title>
<style>
  :root {
    --line:#d1d5db;
    --ink:#111827;
    --muted:#6b7280;
  }
  body {
    margin:0;
    padding:0;
    background:#f3f4f6;
    font-family: Arial, sans-serif;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
  }
  .sticker {
    background:#fff;
    border:2px solid #10b981;
    border-radius:8px;
    width:90mm; /* العرض أكبر */
    height:60mm; /* الطول أصغر */
    max-width:95vw;
    box-shadow:0 8px 24px rgba(0,0,0,.15);
    display:grid;
    grid-template-rows:15mm 1fr;
    padding:5mm;
  }
  .head {
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  .head img {
    height:12mm;
    object-fit:contain;
  }
  .title {
    font-weight:bold;
    font-size:14px;
    text-align:center;
    flex:1;
  }
  .body {
    display:grid;
    grid-template-columns:28mm 1fr; /* QR يسار والبيانات يمين */
    gap:5mm;
    align-items:center;
  }
  .qr {
    width:28mm;
    height:28mm;
    border:1px solid var(--line);
    display:flex;
    justify-content:center;
    align-items:center;
    border-radius:4px;
  }
  .qr img {
    width:100%;
    height:100%;
    object-fit:contain;
  }
  .kv {
    display:grid;
    grid-template-columns:35% 65%;
    row-gap:2mm;
    font-size:11px;
  }
  .k { color:var(--muted); }
  .v { font-weight:bold; }
  .footer {
    font-size:10px;
    color:var(--muted);
    margin-top:2mm;
    text-align:right;
  }
  @media print {
    body { background:#fff; }
    .sticker { box-shadow:none; margin:0 auto; }
    .toolbar { display:none; }
  }
  .toolbar {
    position:fixed;
    bottom:10px;
    left:0;right:0;
    display:flex;
    justify-content:center;
    gap:10px;
  }
  .btn {
    padding:8px 14px;
    border:1px solid var(--line);
    border-radius:6px;
    background:#fff;
    cursor:pointer;
    font-weight:bold;
  }
</style>
</head>
<body>
<div class="sticker" id="sticker">
  <div class="head">
    <img src="FGC.jpeg" alt="FGC"/>
    <div class="title">Preventive Maintenance</div>
    <img src="TabukCluster.jpeg" alt="Tabuk"/>
  </div>
  <div class="body">
    <div class="qr"><img id="qr" alt="QR"/></div>
    <div class="kv">
      <div class="k">Control</div><div class="v" id="v_control">—</div>
      <div class="k">Name</div><div class="v" id="v_name">—</div>
      <div class="k">Brand</div><div class="v" id="v_brand">—</div>
      <div class="k">Serial</div><div class="v" id="v_serial">—</div>
      <div class="k">PM Date</div><div class="v" id="v_pm">—</div>
      <div class="k">Next PM</div><div class="v" id="v_next">—</div>
      <div class="k">Technician</div><div class="v" id="v_tech">—</div>
      <div class="k">Site</div><div class="v" id="v_site">—</div>
      <div class="k">Department</div><div class="v" id="v_dept">—</div>
    </div>
  </div>
</div>

<div class="toolbar">
  <button class="btn" onclick="window.print()">Print</button>
  <button class="btn" id="copyBtn">Copy scan link</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
  authDomain: "pmqrtabuk.firebaseapp.com",
  projectId: "pmqrtabuk",
  storageBucket: "pmqrtabuk.firebasestorage.app",
  messagingSenderId: "305570616285",
  appId: "1:305570616285:web:4f6839fd08b8b5aa131c34"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const $ = s => document.querySelector(s);
const fmt = d => d ? new Date(d).toISOString().slice(0,10) : '—';
const safeId = s => (s||'').trim().replace(/[\/#?\s]/g,'-');
function currentLink(control){
  const base = location.origin + location.pathname;
  return `${base}#view/${encodeURIComponent(control)}`;
}

async function loadSticker(){
  const parts = (location.hash||'').split('/');
  const controlRaw = parts[1] ? decodeURIComponent(parts[1]) : '';
  if(!controlRaw){ return; }
  let snap = await getDoc(doc(db,'assets', safeId(controlRaw)));
  if(!snap.exists()){
    const qs = await getDocs(query(collection(db,'assets'), where('control','==', controlRaw)));
    snap = qs.docs[0];
  }
  if(!snap || !snap.exists()){ return; }
  const d = snap.data();
  $('#v_control').textContent = d.control||'—';
  $('#v_name').textContent = d.name||'—';
  $('#v_brand').textContent = d.brand||'—';
  $('#v_serial').textContent = d.serial||'—';
  $('#v_pm').textContent = fmt(d.pm_date);
  $('#v_next').textContent = fmt(d.next_date);
  $('#v_tech').textContent = d.tech||'—';
  $('#v_site').textContent = d.site||'—';
  $('#v_dept').textContent = d.department||'—';

  const link = currentLink(d.control||controlRaw);
  QRCode.toDataURL(link, {width:220, margin:1})
    .then(url=> $('#qr').src = url)
    .catch(()=> $('#qr').src = "https://chart.googleapis.com/chart?cht=qr&chs=220x220&chl="+encodeURIComponent(link));

  $('#copyBtn').onclick = async ()=>{
    try{ await navigator.clipboard.writeText(link); $('#copyBtn').textContent='Copied ✅'; setTimeout(()=>$('#copyBtn').textContent='Copy scan link',1200);}catch{}
  };
}
window.addEventListener('load', loadSticker);
window.addEventListener('hashchange', loadSticker);
</script>
</body>
</html>
