<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PM-QR â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{background:#0b1220;color:#e5e7eb}
  .card{background:#111827;border:1px solid #1f2937;border-radius:16px;box-shadow:0 12px 36px rgba(0,0,0,.35)}
  .notice{position:sticky;top:0;z-index:40;text-align:center;font-weight:800}
  .n-ok{background:rgba(16,185,129,.15);border-bottom:1px solid rgba(16,185,129,.5);color:#a7f3d0}
  .n-err{background:rgba(239,68,68,.15);border-bottom:1px solid rgba(239,68,68,.5);color:#fecaca}
  .n-info{background:rgba(59,130,246,.15);border-bottom:1px solid rgba(59,130,246,.5);color:#bfdbfe}
  table td,table th{white-space:nowrap}
  .pill{padding:.2rem .5rem;border-radius:999px;font-size:.75rem;font-weight:800}
  .role-admin{background:#fde68a;color:#78350f}
  .role-engineer{background:#bfdbfe;color:#1e3a8a}
  .role-tech{background:#bbf7d0;color:#14532d}
  .role-viewer{background:#e5e7eb;color:#111827}

  .modal{background:#ffffff !important;color:#0f172a !important}
  .modal input,.modal select{
    background:#f8fafc !important;color:#0f172a !important;border:1px solid #cbd5e1 !important;
    border-radius:10px;padding:10px;
  }
  .pick-col{border:1px solid #cbd5e1;border-radius:12px;background:#fff}
  .pick-list{max-height:220px;overflow:auto}
  .pick-item{display:flex;align-items:center;justify-content:space-between;gap:.5rem;padding:.45rem .6rem;border-bottom:1px dashed #e5e7eb;cursor:pointer}
  .pick-item:hover{background:#f1f5f9}
  .chip{display:inline-flex;align-items:center;gap:.35rem;background:#0ea5e9;color:#072d3b;border-radius:999px;padding:.25rem .5rem;margin:.25rem;font-weight:700}
  .chip button{background:transparent;border:0;font-weight:900;cursor:pointer}
</style>
</head>
<body class="min-h-screen">
  <div id="notice" class="notice n-info w-full py-2">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øªâ€¦</div>

  <header class="sticky top-0 z-30 bg-slate-900/80 backdrop-blur border-b border-slate-800">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="font-extrabold text-xl flex items-center gap-2">
        <span class="text-sky-400">ğŸ‘‘</span> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      </div>
      <div class="flex items-center gap-2">
        <a href="index.html" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 hover:opacity-90">â† Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø©</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">

    <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¬Ø¯ÙˆÙ„ users -->
    <section class="card p-4">
      <h2 class="text-lg font-extrabold mb-3">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (users)</h2>

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-end">
        <!-- ÙˆØ¶Ø¹ Ø¬Ù„Ø¨ Ù…Ù† Authentication -->
        <div class="lg:col-span-3">
          <label class="block mb-1 text-slate-300">UID Ø£Ùˆ Email (Ù…Ù† Authentication)</label>
          <input id="fetch_key" placeholder="uid Ø£Ùˆ user@domain.com" class="w-full px-3 py-2 rounded bg-slate-950 border border-slate-800"/>
        </div>
        <div class="lg:col-span-2">
          <button id="btnFetchAuth" class="w-full px-3 py-2 rounded bg-indigo-500 text-white font-bold">Ø¬Ù„Ø¨ Ù…Ù† Authentication</button>
        </div>
        <div class="lg:col-span-7 text-sm text-slate-400">
          <div>Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹ **Cloud Function** Ø§Ø³Ù…Ù‡Ø§ <code>adminGetAuthUser</code> (Callable) ØªØ±Ø¬Ø¹ { uid, email, displayName }.</div>
          <div>Ù„Ùˆ Ø§Ù„ÙÙ†ÙƒØ´Ù† Ù…Ø´ Ù…ØªØ§Ø­Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¨Ø§Ù„Ø£Ø³ÙÙ„.</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-4">
        <div class="md:col-span-1">
          <label class="block mb-1 text-slate-300">UID (Ù…Ø·Ù„ÙˆØ¨)</label>
          <input id="nu_uid" placeholder="Ù…Ø«Ø§Ù„: H8Xs...A1" class="w-full px-3 py-2 rounded bg-slate-950 border border-slate-800"/>
        </div>
        <div class="md:col-span-1">
          <label class="block mb-1 text-slate-300">Email</label>
          <input id="nu_email" type="email" placeholder="user@domain.com" class="w-full px-3 py-2 rounded bg-slate-950 border border-slate-800"/>
        </div>
        <div class="md:col-span-1">
          <label class="block mb-1 text-slate-300">Ø§Ù„Ø§Ø³Ù…</label>
          <input id="nu_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" class="w-full px-3 py-2 rounded bg-slate-950 border border-slate-800"/>
        </div>
        <div class="md:col-span-1">
          <label class="block mb-1 text-slate-300">Ø§Ù„Ø¯ÙˆØ±</label>
          <select id="nu_role" class="w-full px-3 py-2 rounded bg-slate-950 border border-slate-800">
            <option value="viewer">viewer</option>
            <option value="tech">tech</option>
            <option value="engineer">engineer</option>
            <option value="admin">admin</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
        <!-- Ù…ÙˆØ§Ù‚Ø¹ -->
        <div>
          <div class="mb-2 font-bold">Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§</div>
          <div class="grid grid-cols-2 gap-3">
            <div class="pick-col">
              <input id="nu_sitesSearch" class="w-full border-0 border-b border-slate-200 rounded-none px-3 py-2" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙ‚Ø¹â€¦"/>
              <div id="nu_sitesList" class="pick-list"></div>
            </div>
            <div class="pick-col p-2">
              <div class="text-sm text-slate-600 mb-1">Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:</div>
              <div id="nu_sitesChosen" class="min-h-[44px]"></div>
              <input id="nu_sitesExtra" class="mt-2 w-full px-3 py-2 border border-slate-200 rounded-lg" placeholder="Ø¥Ø¶Ø§ÙØ§Øª ÙŠØ¯ÙˆÙŠØ© (Ø¨ÙÙˆØ§ØµÙ„)"/>
            </div>
          </div>
        </div>
        <!-- Ø£Ù‚Ø³Ø§Ù… -->
        <div>
          <div class="mb-2 font-bold">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§</div>
          <div class="grid grid-cols-2 gap-3">
            <div class="pick-col">
              <input id="nu_deptsSearch" class="w-full border-0 border-b border-slate-200 rounded-none px-3 py-2" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø³Ù…â€¦"/>
              <div id="nu_deptsList" class="pick-list"></div>
            </div>
            <div class="pick-col p-2">
              <div class="text-sm text-slate-600 mb-1">Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:</div>
              <div id="nu_deptsChosen" class="min-h-[44px]"></div>
              <input id="nu_deptsExtra" class="mt-2 w-full px-3 py-2 border border-slate-200 rounded-lg" placeholder="Ø¥Ø¶Ø§ÙØ§Øª ÙŠØ¯ÙˆÙŠØ© (Ø¨ÙÙˆØ§ØµÙ„)"/>
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-2 mt-4">
        <button id="nu_save" class="px-4 py-2 rounded bg-sky-600 text-white font-bold hover:opacity-90">Ø­ÙØ¸ ÙÙŠ users</button>
      </div>
    </section>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
    <section class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-extrabold">ğŸ‘¥ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
        <div class="flex items-center gap-2">
          <input id="q" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯â€¦" class="w-64 px-3 py-2 rounded-lg border border-slate-700 bg-slate-900 text-white"/>
          <button id="btnRefresh" class="px-3 py-2 rounded bg-slate-700 hover:opacity-90">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-800 text-slate-200">
            <tr>
              <th class="p-3 text-right">Ø§Ù„Ø§Ø³Ù…</th>
              <th class="p-3 text-right">Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
              <th class="p-3 text-right">Ø§Ù„Ø¯ÙˆØ±</th>
              <th class="p-3 text-right">Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</th>
              <th class="p-3 text-right">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</th>
              <th class="p-3 text-right">Ø£Ø¯ÙˆØ§Øª</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ -->
  <div id="editModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center">
    <div class="modal rounded-xl p-5 w-full max-w-4xl shadow-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…</h3>
        <button id="closeEdit" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">âœ•</button>
      </div>
      <input id="e_uid" type="hidden"/>
      <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
        <input id="e_name"  placeholder="Ø§Ù„Ø§Ø³Ù…"  class="md:col-span-2"/>
        <input id="e_email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯" class="md:col-span-2"/>
        <select id="e_role"  class="md:col-span-2">
          <option value="viewer">viewer</option>
          <option value="tech">tech</option>
          <option value="engineer">engineer</option>
          <option value="admin">admin</option>
        </select>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
        <div>
          <div class="mb-2 font-bold">Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</div>
          <div class="grid grid-cols-2 gap-3">
            <div class="pick-col">
              <input id="e_sitesSearch" class="w-full border-0 border-b border-slate-200 rounded-none px-3 py-2" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙ‚Ø¹â€¦"/>
              <div id="e_sitesList" class="pick-list"></div>
            </div>
            <div class="pick-col p-2">
              <div class="text-sm text-slate-600 mb-1">Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:</div>
              <div id="e_sitesChosen" class="min-h-[44px]"></div>
              <input id="e_sitesExtra" class="mt-2 w-full px-3 py-2 border border-slate-200 rounded-lg" placeholder="Ø¥Ø¶Ø§ÙØ§Øª ÙŠØ¯ÙˆÙŠØ© (Ø¨ÙÙˆØ§ØµÙ„)"/>
            </div>
          </div>
        </div>
        <div>
          <div class="mb-2 font-bold">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
          <div class="grid grid-cols-2 gap-3">
            <div class="pick-col">
              <input id="e_deptsSearch" class="w-full border-0 border-b border-slate-200 rounded-none px-3 py-2" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø³Ù…â€¦"/>
              <div id="e_deptsList" class="pick-list"></div>
            </div>
            <div class="pick-col p-2">
              <div class="text-sm text-slate-600 mb-1">Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:</div>
              <div id="e_deptsChosen" class="min-h-[44px]"></div>
              <input id="e_deptsExtra" class="mt-2 w-full px-3 py-2 border border-slate-200 rounded-lg" placeholder="Ø¥Ø¶Ø§ÙØ§Øª ÙŠØ¯ÙˆÙŠØ© (Ø¨ÙÙˆØ§ØµÙ„)"/>
            </div>
          </div>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="saveEdit" class="px-4 py-2 rounded bg-sky-600 text-white font-bold hover:opacity-90">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-functions.js";
import {
  getFirestore, collection, getDocs, setDoc, updateDoc, deleteDoc, doc, serverTimestamp, getDoc, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
  authDomain: "pmqrtabuk.firebaseapp.com",
  projectId: "pmqrtabuk",
  storageBucket: "pmqrtabuk.firebasestorage.app",
  messagingSenderId: "305570616285",
  appId: "1:305570616285:web:4f6839fd08b8b5aa131c34"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const functions = getFunctions(app);

/* Helpers */
const $ = s => document.querySelector(s);
const notice=(m,t='info')=>{
  const n=$('#notice');
  n.textContent=m;
  n.className='notice ' + (t==='ok'?'n-ok': t==='error'?'n-err':'n-info');
};

/* AUTH GUARD (admin only) */
let currentRole = null;
onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.href='login.html'; return; }
  try{
    const snap = await getDoc(doc(db,'users', user.uid));
    currentRole = snap.exists()? (snap.data().role || 'viewer') : 'viewer';
  }catch{ currentRole = 'viewer'; }
  if(currentRole!=='admin'){
    notice('Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·. Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„ÙˆØ­Ø©â€¦','error');
    setTimeout(()=> location.href='index.html', 1200);
    return;
  }
  notice('ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª âœ…','ok');
  await loadAssetsLookups();
  await loadUsers();
});

/* Lookups Ù…Ù† Ø§Ù„Ø£ØµÙˆÙ„ Ù„Ø¨Ù†Ø§Ø¡ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹/Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
let ALL_SITES=[], ALL_DEPTS=[];
async function loadAssetsLookups(){
  const qs = await getDocs(query(collection(db,'assets'), orderBy('site')));
  const s=new Set(), d=new Set();
  qs.forEach(docu=>{
    const x=docu.data();
    if(x.site) s.add(x.site);
    if(x.department) d.add(x.department);
  });
  ALL_SITES=[...s].sort(); ALL_DEPTS=[...d].sort();
  buildPicker('nu_sites', ALL_SITES, []);
  buildPicker('nu_depts', ALL_DEPTS, []);
}

/* Picker component (Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹/Ø§Ù„Ø£Ù‚Ø³Ø§Ù…) */
const pickers = {};
function buildPicker(key, items, preselected=[]){
  const inputSearch = $(`#${key}Search`);
  const listEl      = $(`#${key}List`);
  const chosenEl    = $(`#${key}Chosen`);
  const chosen = new Set(preselected);

  function renderList(){
    const q=(inputSearch.value||'').toLowerCase().trim();
    listEl.innerHTML='';
    items.filter(v=>!q || v.toLowerCase().includes(q)).forEach(val=>{
      const div=document.createElement('div');
      div.className='pick-item';
      div.innerHTML=`<span>${val}</span><span class="text-slate-400">+</span>`;
      div.onclick=()=>{ if(!chosen.has(val)){ chosen.add(val); renderChosen(); } };
      listEl.appendChild(div);
    });
  }
  function renderChosen(){
    chosenEl.innerHTML='';
    Array.from(chosen).sort().forEach(val=>{
      const chip=document.createElement('span');
      chip.className='chip';
      chip.innerHTML=`<span>${val}</span><button title="Ø¥Ø²Ø§Ù„Ø©">âœ•</button>`;
      chip.querySelector('button').onclick=()=>{ chosen.delete(val); renderChosen(); };
      chosenEl.appendChild(chip);
    });
  }
  inputSearch.oninput=renderList;
  renderList(); renderChosen();
  pickers[key]={ get:()=>Array.from(chosen), set:(arr)=>{ chosen.clear(); (arr||[]).forEach(v=>chosen.add(v)); renderChosen(); } };
}

/* Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© users */
document.getElementById('btnFetchAuth').addEventListener('click', async ()=>{
  const key = $('#fetch_key').value.trim();
  if(!key){ notice('Ø§ÙƒØªØ¨ UID Ø£Ùˆ Email Ø£ÙˆÙ„Ø§Ù‹','error'); return; }
  try{
    // Ù†Ø³ØªØ¯Ø¹ÙŠ Callable Function Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©
    const call = httpsCallable(functions, 'adminGetAuthUser');
    const res = await call({ key }); // { uid, email, displayName }
    const u = res.data || {};
    if(!u.uid){ notice('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙŠ Authentication','error'); return; }
    // Ø¹Ø¨Ù‘ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„
    $('#nu_uid').value   = u.uid || '';
    $('#nu_email').value = u.email || '';
    $('#nu_name').value  = u.displayName || '';
    notice('ØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Authentication âœ…','ok');
  }catch(e){
    // Ù„Ùˆ Ø§Ù„ÙÙ†ÙƒØ´Ù† Ù…Ø´ Ù…ØªØ§Ø­Ø© Ø£Ùˆ Ø±ÙØ¶Øª
    notice('ØªØ¹Ø°Ø± Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† Authentication. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙŠØ¯ÙˆÙŠÙ‹Ø§.','error');
    console.error(e);
  }
});

document.getElementById('nu_save').addEventListener('click', async ()=>{
  const uid   = $('#nu_uid').value.trim();
  const email = $('#nu_email').value.trim();
  const name  = $('#nu_name').value.trim();
  const role  = $('#nu_role').value;
  if(!uid){ notice('UID Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ†Ø¯','error'); return; }

  let sites = pickers['nu_sites']?.get() || [];
  let depts = pickers['nu_depts']?.get() || [];
  const sExtra = ($('#nu_sitesExtra').value||'').split(',').map(x=>x.trim()).filter(Boolean);
  const dExtra = ($('#nu_deptsExtra').value||'').split(',').map(x=>x.trim()).filter(Boolean);
  sites = Array.from(new Set([...sites, ...sExtra]));
  depts = Array.from(new Set([...depts, ...dExtra]));

  try{
    await setDoc(doc(db,'users', uid), {
      name, email, role, sites, departments: depts, updatedAt: serverTimestamp()
    }, { merge: true });
    notice('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ users âœ…','ok');
    // Ù†Ø¸Ù‘Ù Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    // $('#nu_uid').value=''; $('#nu_email').value=''; $('#nu_name').value=''; $('#nu_role').value='viewer';
    $('#nu_sitesExtra').value=''; $('#nu_deptsExtra').value='';
    await loadUsers();
  }catch(e){
    notice('ÙØ´Ù„ Ø­ÙØ¸ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: '+e.message,'error');
  }
});

/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø¹Ø±Ø¶/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù) */
let users=[], filtered=[];
async function loadUsers(){
  try{
    notice('Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†â€¦');
    const qs = await getDocs(query(collection(db,'users'), orderBy('email')));
    users = qs.docs.map(d=> ({ id: d.id, ...d.data() }));
    filtered = users.slice();
    renderTable();
    notice('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ âœ…','ok');
  }catch(e){ notice('ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: '+e.message,'error'); }
}
function rolePill(role){
  const map={admin:'role-admin',engineer:'role-engineer',tech:'role-tech',viewer:'role-viewer'};
  return `<span class="pill ${map[role]||'role-viewer'}">${role||'viewer'}</span>`;
}
function renderTable(){
  const q = ($('#q').value||'').toLowerCase().trim();
  filtered = users.filter(u=> !q || (String(u.name||'').toLowerCase().includes(q) || String(u.email||'').toLowerCase().includes(q)));
  const tb = $('#tbody'); tb.innerHTML='';
  for(const u of filtered){
    const tr = document.createElement('tr');
    tr.className='border-b border-slate-800';
    const sites = Array.isArray(u.sites)? u.sites.join(', ') : '';
    const depts = Array.isArray(u.departments)? u.departments.join(', ') : '';
    tr.innerHTML = `
      <td class="p-3">${u.name||'â€”'}</td>
      <td class="p-3">${u.email||'â€”'}</td>
      <td class="p-3">${rolePill(u.role||'viewer')}</td>
      <td class="p-3">${sites||'â€”'}</td>
      <td class="p-3">${depts||'â€”'}</td>
      <td class="p-3">
        <div class="flex gap-2">
          <button class="px-2 py-1 rounded bg-sky-500 text-sky-950 font-bold hover:opacity-90" data-edit="${u.id}">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="px-2 py-1 rounded bg-red-600 text-white font-bold hover:opacity-90" data-del="${u.id}">Ø­Ø°Ù</button>
        </div>
      </td>
    `;
    tb.appendChild(tr);
  }
}
document.getElementById('q').addEventListener('input', renderTable);
document.getElementById('btnRefresh').addEventListener('click', loadUsers);

/* ØªØ¹Ø¯ÙŠÙ„ */
const editModal = $('#editModal');
const openEdit = ()=>{ editModal.classList.remove('hidden'); editModal.classList.add('flex'); };
const closeEdit = ()=>{ editModal.classList.add('hidden'); editModal.classList.remove('flex'); };
document.getElementById('closeEdit').onclick = closeEdit;

document.addEventListener('click', (e)=>{
  const b = e.target.closest('button[data-edit]');
  if(!b) return;
  const uid=b.dataset.edit;
  const u = users.find(x=> x.id===uid);
  if(!u) return;
  $('#e_uid').value   = uid;
  $('#e_name').value  = u.name || '';
  $('#e_email').value = u.email||'';
  $('#e_role').value  = u.role || 'viewer';
  buildPicker('e_sites', ALL_SITES, u.sites||[]);
  buildPicker('e_depts', ALL_DEPTS, u.departments||[]);
  $('#e_sitesExtra').value=''; $('#e_deptsExtra').value='';
  openEdit();
});

document.getElementById('saveEdit').addEventListener('click', async ()=>{
  const uid = $('#e_uid').value;
  const name  = $('#e_name').value.trim();
  const email = $('#e_email').value.trim();
  const role  = $('#e_role').value;
  let sites = pickers['e_sites']?.get() || [];
  let depts = pickers['e_depts']?.get() || [];
  const sExtra = ($('#e_sitesExtra').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const dExtra = ($('#e_deptsExtra').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  sites = Array.from(new Set([...sites, ...sExtra]));
  depts = Array.from(new Set([...depts, ...dExtra]));
  try{
    await updateDoc(doc(db,'users', uid), { name, email, role, sites, departments: depts, updatedAt: serverTimestamp() });
    notice('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…','ok');
    closeEdit(); await loadUsers();
  }catch(e){ notice('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: '+e.message,'error'); }
});

/* Ø­Ø°Ù Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore (Ù„ÙŠØ³ Ù…Ù† Authentication) */
document.addEventListener('click', async (e)=>{
  const b = e.target.closest('button[data-del]');
  if(!b) return;
  const uid=b.dataset.del;
  if(!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore ÙÙ‚Ø·. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
  try{
    await deleteDoc(doc(db,'users', uid));
    notice('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯ âœ…','ok');
    await loadUsers();
  }catch(err){ notice('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: '+err.message,'error'); }
});

/* Ø£Ø®Ø·Ø§Ø¡ Ø¹Ø§Ù…Ø© */
window.addEventListener('error', e=> notice('Ø®Ø·Ø£: '+(e.error?.message||e.message),'error'));
window.addEventListener('unhandledrejection', e=> notice('Ø®Ø·Ø£: '+(e.reason?.message||e.reason),'error'));
</script>
</body>
</html>
