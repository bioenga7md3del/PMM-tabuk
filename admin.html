<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>إدارة المستخدمين • PPM TABUK</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:#0b1220;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .card{background:#111827;border:1px solid #1f2937;border-radius:16px;box-shadow:0 12px 36px rgba(0,0,0,.35)}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#0f172a;border:1px solid #1f2937;border-radius:999px;padding:.25rem .6rem;font-size:.8rem}
    .chip button{background:transparent;border:0;color:#93c5fd;cursor:pointer}
    .notice{position:sticky;top:0;z-index:50;text-align:center;font-weight:800}
    .n-ok{background:rgba(16,185,129,.15);border-bottom:1px solid rgba(16,185,129,.5);color:#a7f3d0}
    .n-err{background:rgba(239,68,68,.15);border-bottom:1px solid rgba(239,68,68,.5);color:#fecaca}
    .n-info{background:rgba(59,130,246,.15);border-bottom:1px solid rgba(59,130,246,.5);color:#bfdbfe}
  </style>
</head>
<body>
  <div id="notice" class="notice n-info">جارِ التحقق من الصلاحيات…</div>

  <header class="sticky top-0 z-40 bg-slate-900/70 backdrop-blur border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-3 md:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="assets/TabukCluster.jpeg" class="h-8 hidden sm:block rounded" alt="Tabuk"/>
        <img src="assets/FGC.jpeg" class="h-7 hidden sm:block rounded" alt="FGC"/>
        <div class="font-extrabold text-lg md:text-xl">PPM TABUK</div>
        <span class="text-sm text-slate-400 hidden md:inline">• إدارة المستخدمين</span>
      </div>
      <div class="flex items-center gap-2">
        <a href="index.html" class="px-3 py-2 rounded bg-slate-600 text-slate-100 font-bold">لوحة التحكم</a>
        <button id="btnLogout" class="px-3 py-2 rounded bg-red-500 text-white font-bold">خروج</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-3 md:p-6 space-y-6">
    <!-- أدوات -->
    <section class="card p-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <input id="q" class="px-3 py-2 rounded bg-slate-900 border border-slate-700" placeholder="بحث بالاسم/الإيميل"/>
        <div class="flex items-center gap-2">
          <label class="text-sm text-slate-400">الفرز</label>
          <select id="sort" class="px-3 py-2 rounded bg-slate-900 border border-slate-700">
            <option value="name">الاسم</option>
            <option value="role">الدور</option>
            <option value="email">الإيميل</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-slate-400">الدور</label>
          <select id="roleFilter" class="px-3 py-2 rounded bg-slate-900 border border-slate-700">
            <option value="">الكل</option>
            <option>admin</option><option>engineer</option><option>tech</option><option>viewer</option>
          </select>
        </div>
        <div class="text-right">
          <button id="btnRefresh" class="px-3 py-2 rounded bg-sky-500 text-slate-900 font-bold">تحديث</button>
        </div>
      </div>
    </section>

    <!-- جدول المستخدمين -->
    <section class="card p-3">
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-800 text-slate-200">
            <tr>
              <th class="p-2 text-left">الاسم</th>
              <th class="p-2 text-left">البريد</th>
              <th class="p-2 text-left">الدور</th>
              <th class="p-2 text-left">Sites</th>
              <th class="p-2 text-left">Departments</th>
              <th class="p-2 text-left">أدوات</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <template id="rowTmpl">
    <tr class="border-b border-slate-800 align-top">
      <td class="p-2">
        <div class="font-bold name"></div>
        <div class="text-xs text-slate-400 uid"></div>
      </td>
      <td class="p-2 email"></td>
      <td class="p-2">
        <select class="role px-2 py-1 rounded bg-slate-900 border border-slate-700">
          <option>admin</option><option>engineer</option><option>tech</option><option selected>viewer</option>
        </select>
      </td>
      <td class="p-2">
        <div class="flex flex-wrap gap-1 items-center">
          <select class="siteSel px-2 py-1 rounded bg-slate-900 border border-slate-700"></select>
          <button class="addSite px-2 py-1 rounded bg-emerald-600 text-slate-900 font-bold">إضافة</button>
        </div>
        <div class="sites mt-2 flex flex-wrap gap-2"></div>
      </td>
      <td class="p-2">
        <div class="flex flex-wrap gap-1 items-center">
          <select class="deptSel px-2 py-1 rounded bg-slate-900 border border-slate-700"></select>
          <button class="addDept px-2 py-1 rounded bg-emerald-600 text-slate-900 font-bold">إضافة</button>
        </div>
        <div class="depts mt-2 flex flex-wrap gap-2"></div>
      </td>
      <td class="p-2">
        <div class="flex flex-wrap gap-1">
          <button class="save px-2 py-1 rounded bg-sky-500 text-slate-900 font-bold">حفظ</button>
          <button class="reset px-2 py-1 rounded bg-slate-600 text-slate-100">Reset Password</button>
        </div>
      </td>
    </tr>
  </template>

  <script type="module">
    import { auth, db } from './js/firebase.js';
    import { onAuthStateChanged, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { canManageUsers, bindLogout } from './js/roles.js';

    const $ = s=>document.querySelector(s);
    const notice = (msg, type='info')=>{
      const n = $('#notice');
      n.textContent = msg;
      n.className = 'notice ' + (type==='ok'?'n-ok':type==='error'?'n-err':'n-info');
    };

    let sites = [], depts = [];
    let users = [];

    function renderChips(container, arr, removeCb){
      container.innerHTML = '';
      arr.forEach((v,i)=>{
        const chip = document.createElement('span');
        chip.className='chip';
        chip.innerHTML = \`\${v} <button title="إزالة">✕</button>\`;
        chip.querySelector('button').onclick = ()=> removeCb(i);
        container.appendChild(chip);
      });
    }

    function fillSelect(sel, options){
      sel.innerHTML = '<option value="">— اختر —</option>' + options.map(o=>\`<option>\${o}</option>\`).join('');
    }

    async function loadSitesDepts(){
      const qs = await getDocs(collection(db,'assets'));
      const arr = qs.docs.map(d=> d.data());
      sites = [...new Set(arr.map(x=>x.site).filter(Boolean))].sort();
      depts = [...new Set(arr.map(x=>x.department).filter(Boolean))].sort();
    }

    function passFilters(u){
      const q = ($('#q').value||'').toLowerCase().trim();
      const rf= $('#roleFilter').value;
      const blob = [u.name,u.email].map(v=>String(v||'').toLowerCase()).join('|');
      if(q && !blob.includes(q)) return false;
      if(rf && u.role!==rf) return false;
      return true;
    }

    function sortUsers(a,b){
      const s = $('#sort').value;
      const av = (a[s]||'').toString().toLowerCase();
      const bv = (b[s]||'').toString().toLowerCase();
      return av.localeCompare(bv,'ar');
    }

    async function loadUsers(){
      const qs = await getDocs(collection(db,'users'));
      users = qs.docs.map(d=>({ id:d.id, ...d.data(), sites: Array.isArray(d.data().sites)? d.data().sites:[], departments: Array.isArray(d.data().departments)? d.data().departments:[] }));
    }

    function render(){
      const tb = $('#tbody'); tb.innerHTML='';
      users.filter(passFilters).sort(sortUsers).forEach(u=>{
        const tr = document.importNode($('#rowTmpl').content, true);
        tr.querySelector('.name').textContent = u.name || '—';
        tr.querySelector('.uid').textContent  = u.id;
        tr.querySelector('.email').textContent= u.email || '—';
        tr.querySelector('.role').value = u.role || 'viewer';

        const siteSel = tr.querySelector('.siteSel');
        const deptSel = tr.querySelector('.deptSel');
        fillSelect(siteSel, sites);
        fillSelect(deptSel, depts);

        const sitesBox = tr.querySelector('.sites');
        const deptsBox = tr.querySelector('.depts');
        let sitesArr = [...u.sites];
        let deptsArr = [...u.departments];

        renderChips(sitesBox, sitesArr, (i)=>{ sitesArr.splice(i,1); renderChips(sitesBox, sitesArr, (i2)=>{ sitesArr.splice(i2,1); renderChips(sitesBox, sitesArr, ()=>{}); }); });
        renderChips(deptsBox, deptsArr, (i)=>{ deptsArr.splice(i,1); renderChips(deptsBox, deptsArr, (i2)=>{ deptsArr.splice(i2,1); renderChips(deptsBox, deptsArr, ()=>{}); }); });

        tr.querySelector('.addSite').onclick = ()=>{
          const v = siteSel.value; if(v && !sitesArr.includes(v)){ sitesArr.push(v); renderChips(sitesBox, sitesArr, (i)=>{ sitesArr.splice(i,1); renderChips(sitesBox, sitesArr, ()=>{}); }); }
        };
        tr.querySelector('.addDept').onclick = ()=>{
          const v = deptSel.value; if(v && !deptsArr.includes(v)){ deptsArr.push(v); renderChips(deptsBox, deptsArr, (i)=>{ deptsArr.splice(i,1); renderChips(deptsBox, deptsArr, ()=>{}); }); }
        };

        tr.querySelector('.save').onclick = async ()=>{
          try{
            const role = tr.querySelector('.role').value;
            await updateDoc(doc(db,'users', u.id), { role, sites: sitesArr, departments: deptsArr });
            notice('تم الحفظ ✅','ok');
          }catch(e){ notice('فشل الحفظ: '+e.message,'error'); }
        };

        tr.querySelector('.reset').onclick = async ()=>{
          if(!u.email){ notice('لا يوجد بريد لهذا المستخدم','error'); return; }
          try{
            await sendPasswordResetEmail(auth, u.email);
            notice('تم إرسال رابط إعادة تعيين كلمة المرور ✅','ok');
          }catch(e){ notice('خطأ: '+e.message,'error'); }
        };

        $('#tbody').appendChild(tr);
      });
    }

    async function boot(){
      onAuthStateChanged(auth, async (u)=>{
        if(!u){ location.href='login.html'; return; }
        // bind logout
        bindLogout();

        if(!canManageUsers()){
          notice('صلاحيات غير كافية — سيتم إعادتك للوحة التحكم','error');
          setTimeout(()=> location.href='index.html', 1400);
          return;
        }
        try{
          notice('جارِ التحميل…');
          await loadSitesDepts();
          await loadUsers();
          render();
          notice('جاهز ✅','ok');
        }catch(e){ notice('فشل التحميل: '+e.message,'error'); }
      });

      $('#btnRefresh').onclick = async ()=>{ await loadUsers(); render(); };
      $('#q').addEventListener('input', render);
      $('#sort').addEventListener('change', render);
      $('#roleFilter').addEventListener('change', render);
    }

    boot();
  </script>
</body>
</html>
