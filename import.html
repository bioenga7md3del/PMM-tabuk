<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>استيراد الأصول إلى Firestore • PPM TABUK</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- SheetJS (نسخة جلوبال) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<!-- خط عربي -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">

<style>
  :root { color-scheme: dark; }
  body{background:#0b1220; font-family: "Tajawal", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", "Noto Sans Arabic", Arial, sans-serif;}
  .shell{max-width:1200px;margin-inline:auto;padding:18px}
  .panel{background:#0f172a;border:1px solid #1f2937;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
  .title{font-weight:900;letter-spacing:.5px}
  .muted{color:#94a3b8}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #374151;border-radius:999px;background:#0b1220;color:#e5e7eb}
  .btn{padding:.65rem 1rem;border-radius:.8rem;font-weight:800}
  .btn-blue{background:#3b82f6;color:#eaf2ff}
  .btn-green{background:#10b981;color:#062e2e}
  .btn-rose{background:#ef4444;color:#fff}
  .notice{position:sticky;top:0;z-index:50;margin:10px auto;max-width:1200px;padding:10px 14px;border-radius:12px;text-align:center;font-weight:800}
  .n-ok{background:rgba(16,185,129,.15);color:#a7f3d0;border:1px solid rgba(16,185,129,.45)}
  .n-info{background:rgba(59,130,246,.15);color:#bfdbfe;border:1px solid rgba(59,130,246,.45)}
  .n-err{background:rgba(239,68,68,.15);color:#fecaca;border:1px solid rgba(239,68,68,.45)}
  table{border-collapse:collapse;width:100%}
  th,td{border-top:1px solid #1f2937;padding:8px 10px;white-space:nowrap}
  th{background:#0b1220;color:#c7d2fe;position:sticky;top:0}
  .box{border:1px solid #1f2937;border-radius:14px;background:#0b1220}
  input[type="file"]{display:none}
</style>
</head>
<body class="text-slate-100">

<!-- إشعار علوي -->
<div id="notice" class="notice n-info">60 صف/دفعة — استورد ملف XLSX/CSV، عاينه ثم ارفعه.</div>

<div class="shell">
  <div class="panel p-4 md:p-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-5">
      <div class="title text-2xl">استيراد الأصول إلى Firestore</div>
      <div class="text-sm muted">control, site, department, location, pm_date, next_date, tech, name, brand, serial</div>
    </div>

    <!-- شريط أدوات -->
    <div class="box p-4 md:p-5 mb-5">
      <div class="grid md:grid-cols-12 gap-3 items-center">
        <!-- أزرار تحميل النماذج -->
        <div class="md:col-span-5 flex flex-wrap gap-2">
          <button id="btnCsv"   type="button" class="btn btn-green">تحميل نموذج (CSV سريع)</button>
          <button id="btnXls"   type="button" class="btn btn-blue">تحميل نموذج (Excel)</button>
          <a id="csvDirect" download="pm_assets_template.csv" class="hidden"></a>
        </div>

        <!-- اختيار ملف -->
        <div class="md:col-span-4 flex items-center gap-2">
          <label for="file" class="pill cursor-pointer">اختر ملف</label>
          <input id="file" type="file" accept=".xlsx,.xls,.csv">
          <span id="fileName" class="muted text-sm"></span>
        </div>

        <!-- الكتابة فوق الموجود + رفع -->
        <div class="md:col-span-3 flex items-center justify-end gap-2">
          <label class="flex items-center gap-2 text-sm">
            <input id="overwrite" type="checkbox" class="accent-sky-500" checked>
            تفعيل كتابة فوق الموجود
          </label>
          <button id="btnUpload" type="button" class="btn btn-blue disabled:opacity-40" disabled>رفع للقاعدة</button>
        </div>
      </div>

      <!-- ملاحظة صغيرة -->
      <div class="mt-3 text-xs muted">
        التواريخ بصيغة <b>YYYY-MM-DD</b>. لو ملف Excel فيه Serial Dates هيتم تحويلها تلقائيًا.
      </div>
    </div>

    <!-- إحصائيات + المعاينة -->
    <div class="flex flex-wrap items-center gap-2 mb-2" id="stats"></div>
    <div class="overflow-auto max-h-[65vh] rounded-xl border border-slate-700">
      <table id="preview"></table>
    </div>

    <!-- أزرار تحت الجدول -->
    <div class="mt-4 flex flex-wrap gap-2">
      <button id="btnClear" type="button" class="btn btn-rose">مسح المعاينة</button>
    </div>
  </div>
</div>

<!-- منطق الواجهة (أزرار النماذج) -->
<script>
(()=> {
  const $ = s=>document.querySelector(s);
  const header = ["control","site","department","location","pm_date","next_date","tech","name","brand","serial"];
  const sample = [
    ["AS-0001","الموقع A","LAB","غرفة 101","2025-01-15","2025-07-15","Ahmed","Infusion Pump","B Braun","SN12345"],
    ["MT/AS/12","mobile","sada","","2025-09-25","2026-03-25","ahmed","","",""]
  ];
  const toCSV = (arr)=>arr.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const csvData = 'data:text/csv;charset=utf-8,' + encodeURIComponent(toCSV([header,...sample]));

  const notice = (msg,type='info')=>{
    const n=$('#notice');
    n.textContent=msg;
    n.className='notice '+(type==='ok'?'n-ok':type==='error'?'n-err':'n-info');
  };

  // تنزيل CSV سريع
  $('#btnCsv').onclick = ()=>{
    const a = $('#csvDirect'); a.href = csvData; a.click();
    notice('تم إنشاء نموذج CSV ✅','ok');
  };

  // تنزيل Excel (لو SheetJS متاحة وإلا CSV)
  $('#btnXls').onclick = ()=>{
    try{
      if(window.XLSX && XLSX.utils && XLSX.writeFile){
        const ws = XLSX.utils.aoa_to_sheet([header,...sample]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "assets_template");
        XLSX.writeFile(wb,"pm_assets_template.xlsx");
        notice('تم إنشاء نموذج Excel ✅','ok');
      }else{
        const a=document.createElement('a'); a.href=csvData; a.download='pm_assets_template.csv'; a.click();
        notice('SheetJS غير متاحة — تم إنشاء CSV بدلاً من ذلك ✅','ok');
      }
    }catch(e){ notice('تعذر إنشاء النموذج: '+(e.message||''),'error'); }
  };
})();
</script>

<!-- Firebase + الاستيراد والرفع -->
<script type="module">
/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, writeBatch, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
  authDomain: "pmqrtabuk.firebaseapp.com",
  projectId: "pmqrtabuk",
  storageBucket: "pmqrtabuk.firebasestorage.app",
  messagingSenderId: "305570616285",
  appId: "1:305570616285:web:4f6839fd08b8b5aa131c34"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* Helpers */
const $ = s=>document.querySelector(s);
const notice = (msg,type='info')=>{
  const n=$('#notice'); n.textContent=msg; n.className='notice '+(type==='ok'?'n-ok':type==='error'?'n-err':'n-info');
};
const required = ["control","site","department","location","pm_date","next_date","tech","name","brand","serial"];
let rows=[];

/* خرائط عناوين عربية -> إنجليزي (اختياري) */
const headerMap = {
  "رقم التحكم":"control","رقم الجهاز":"control","رقم الأصل":"control","control":"control",
  "الموقع":"site","site":"site",
  "القسم":"department","department":"department",
  "المكان":"location","الموقع الداخلي":"location","location":"location",
  "تاريخ الصيانة":"pm_date","pm_date":"pm_date",
  "تاريخ الصيانة القادمة":"next_date","next_date":"next_date",
  "الفني":"tech","tech":"tech",
  "الاسم":"name","name":"name",
  "الماركة":"brand","الشركة المصنعة":"brand","brand":"brand",
  "الرقم التسلسلي":"serial","serial":"serial"
};

/* حدث اختيار الملف */
$('#file').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; 
  if(!f) return;

  // عرض الاسم
  $('#fileName').textContent = f.name;
  notice('جارِ قراءة الملف…');

  try{
    const ext = f.name.toLowerCase().split('.').pop();
    const ab  = await f.arrayBuffer();
    let json = [];

    if(ext==='csv'){
      const text = smartDecodeCSV(new Uint8Array(ab));
      json = csvToJson(text);
      // محاولة تعريب العناوين إلى required
      if (json.length) {
        json = json.map(row=>{
          const o={};
          Object.keys(row).forEach(k=>{
            const keyNorm = (k||"").trim().toLowerCase();
            const mapped = headerMap[keyNorm] || headerMap[k.trim()] || keyNorm;
            o[mapped]=row[k];
          });
          return o;
        });
      }
    }else{
      const XLSX = window.XLSX; // استخدام النسخة الجلوبال
      const wb = XLSX.read(ab,{type:'array', cellDates:true});
      const ws = wb.Sheets[wb.SheetNames[0]];
      json = XLSX.utils.sheet_to_json(ws,{defval:""});
      // نفس فكرة خرائط العناوين لو الإكسل عربي
      if (json.length) {
        json = json.map(row=>{
          const o={};
          Object.keys(row).forEach(k=>{
            const keyNorm = (k||"").trim().toLowerCase();
            const mapped = headerMap[keyNorm] || headerMap[k.trim()] || keyNorm;
            o[mapped]=row[k];
          });
          return o;
        });
      }
    }

    if(json.length===0){
      rows=[]; draw([],[]); $('#btnUpload').disabled=true;
      notice('الملف فارغ','error'); 
      $('#file').value = ""; // للسماح باختيار نفس الملف لاحقًا
      return; 
    }

    // التحقق من الأعمدة (بعد الخرائط)
    const cols = Object.keys(json[0]).map(c=>c.trim());
    const miss = required.filter(c=>!cols.includes(c));
    if(miss.length){
      rows=[]; draw([],[]); $('#btnUpload').disabled=true;
      notice('أعمدة ناقصة: '+miss.join(', '),'error');
      $('#file').value = "";
      return;
    }

    // تجهيز الصفوف وتحويل التواريخ
    rows = json.map(r=>{
      const o={}; required.forEach(c=>o[c]=(r[c]??'').toString().trim());
      const fix=(v)=>{ 
        if(!v) return ""; 
        // رقم مسلسل (Excel serial)؟ 
        if(/^\d+(\.\d+)?$/.test(v)){ 
          try{ return window.XLSX.SSF.format("yyyy-mm-dd",Number(v)); }
          catch{ return ""; }
        }
        const d=new Date(v); 
        return isNaN(d)?v:d.toISOString().slice(0,10);
      };
      o.pm_date=fix(o.pm_date); 
      o.next_date=fix(o.next_date); 
      return o;
    });

    draw(required, rows);
    $('#btnUpload').disabled=false;
    notice(`تمت المعاينة: ${rows.length} صفًا ✅`,'ok');

  }catch(err){
    console.error(err); 
    rows=[]; draw([],[]); $('#btnUpload').disabled=true;
    notice('فشل قراءة الملف: '+(err.message||''),'error');
  } finally {
    // السماح بإعادة اختيار نفس الملف
    e.target.value = "";
  }
});

/* مسح المعاينة */
$('#btnClear').onclick = ()=>{
  rows=[]; draw([],[]); 
  $('#file').value=""; 
  $('#fileName').textContent=""; 
  $('#btnUpload').disabled=true; 
  notice('تم مسح المعاينة','info');
};

/* رفع للفايرستور */
$('#btnUpload').onclick = async ()=>{
  if(!rows.length) return;
  const overwrite = $('#overwrite').checked;
  if(!confirm(`سيتم رفع ${rows.length} صفًا${overwrite?' (مع الكتابة فوق الموجود)':''}. متابعة؟`)) return;

  notice('جارِ الرفع…'); 
  $('#btnUpload').disabled=true;

  const chunk = 60; let ok=0, fail=0;
  const idSafe = s=> s.toString().trim().replace(/[\/#?\s]/g,'-');

  try{
    for(let i=0;i<rows.length;i+=chunk){
      const part = rows.slice(i,i+chunk);
      const batch = writeBatch(db);

      part.forEach(r=>{
        const id = idSafe(r.control||'');
        if(!id){ fail++; return; }
        const data = {
          control:r.control||'', site:r.site||'', department:r.department||'',
          location:r.location||'', pm_date:r.pm_date||'', next_date:r.next_date||'',
          tech:r.tech||'', name:r.name||'', brand:r.brand||'', serial:r.serial||'',
          updatedAt: serverTimestamp()
        };
        batch.set(doc(db,'assets',id), data, { merge: overwrite });
      });

      await batch.commit();
      ok += part.length;
      notice(`تم رفع ${ok}/${rows.length}…`);
    }
    notice(`اكتمل الرفع ✅ تم: ${ok} — فشل: ${fail}`,'ok');
  }catch(err){
    console.error(err); 
    notice('فشل الرفع: '+(err.message||''),'error');
  } finally {
    $('#btnUpload').disabled=false;
  }
};

/* رسم الجدول والإحصائيات */
function draw(cols, data){
  const t = $('#preview');
  if(!cols.length){ t.innerHTML=''; $('#stats').innerHTML=''; return; }

  const thead=`<thead><tr>${cols.map(c=>`<th class="text-right">${c}</th>`).join('')}</tr></thead>`;
  const tbody=`<tbody>${data.map(r=>`<tr>${cols.map(c=>`<td>${esc(r[c]||'')}</td>`).join('')}</tr>`).join('')}</tbody>`;
  t.innerHTML = thead+tbody;

  const invalid = data.filter(r=>(r.pm_date && !/^\d{4}-\d{2}-\d{2}$/.test(r.pm_date)) || (r.next_date && !/^\d{4}-\d{2}-\d{2}$/.test(r.next_date))).length;
  $('#stats').innerHTML = `
    <span class="pill">الصفوف: ${data.length}</span>
    <span class="pill">تواريخ غير منسقة: ${invalid}</span>
    <span class="pill">أعمدة: ${cols.length}</span>
  `;
}

/* Utilities */
function esc(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);}

/* CSV smart decode: UTF-8 -> windows-1256 -> iso-8859-6 */
function smartDecodeCSV(u8){
  // BOM UTF-8؟
  if (u8.length>=3 && u8[0]===0xEF && u8[1]===0xBB && u8[2]===0xBF) {
    return new TextDecoder('utf-8').decode(u8.subarray(3));
  }
  const tryEnc = (enc)=>{ try{ return new TextDecoder(enc).decode(u8); } catch { return null; } };
  const isBad = (txt)=> !txt || (txt.match(/\uFFFD/g)||[]).length > 2; // وجود بدائل كثيرة �
  let t = tryEnc('utf-8');
  if (!isBad(t)) return t;
  t = tryEnc('windows-1256');
  if (!isBad(t)) return t;
  t = tryEnc('iso-8859-6');
  return t || new TextDecoder('utf-8').decode(u8);
}

function csvToJson(text){
  const lines=text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length);
  if(!lines.length) return [];
  const head=splitCSV(lines[0]).map(h=>h.trim());
  return lines.slice(1).map(line=>{
    const c=splitCSV(line); 
    const o={}; head.forEach((h,i)=>o[h]=(c[i]??'').trim()); 
    return o; 
  });
}
function splitCSV(line){
  const out=[]; let cur=''; let q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){ if(q && line[i+1]==='"'){cur+='"'; i++;} else q=!q; }
    else if(ch===',' && !q){ out.push(cur); cur='';}
    else cur+=ch;
  }
  out.push(cur); return out;
}
</script>
</body>
</html>
