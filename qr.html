<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PM-QR — طباعة أكواد QR (Zebra 50×25mm)</title>
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
  :root{ --line:#e5e7eb; --ink:#0f172a; }
  body{background:#f8fafc;color:var(--ink)}
  .card{border:1px solid var(--line);background:#fff;border-radius:10px}
  .hide{display:none!important}

  /* ===== ورقة اللصّاقة: 50×25 مم ===== */
  .sheet{
    background:#fff; color:#000;
    box-shadow:0 10px 30px rgba(0,0,0,.08);
    margin:16px auto; position:relative; overflow:hidden;
    width:50mm; height:25mm;   /* المقاس الفعلي */
  }
  .qr-wrap{
    position:absolute; inset:0; display:flex;
    flex-direction:column; align-items:center; justify-content:center;
  }
  .qr-title{ font-weight:800; text-align:center; line-height:1 }
  .control-text{
    font-weight:900; text-align:center; line-height:1.05;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    letter-spacing: .3px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    max-width: 100%;
  }

  /* شبكة البطاقات (لو حبيت تطبع قسم على ورق عادي) */
  .qr-card{ width:58mm; padding:6mm; text-align:center; page-break-inside:avoid; border:1px solid var(--line); border-radius:8px; background:#fff }
  .qr-img{ object-fit:contain; display:block; margin:0 auto 6mm auto }
  .qr-control{ font-weight:800; font-size:14px; letter-spacing:.5px }
  .grid-print{ display:grid; grid-template-columns:repeat(3, 1fr); gap:8mm }

  /* طباعة */
  @media print{
    .no-print{display:none !important}
    body{background:#fff}
    .sheet{box-shadow:none;margin:0 auto}
  }
  /* مقاس الصفحة عند الطباعة */
  @page{ size:50mm 25mm; margin:0 }
</style>
</head>
<body>
<header class="no-print sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <h1 class="font-extrabold text-lg">طباعة أكواد QR — Zebra 50×25mm</h1>
    <div class="flex items-center gap-2">
      <button id="btnPrint" class="px-3 py-2 rounded bg-sky-600 text-white font-bold">🖨️ طباعة</button>
      <a href="index.html" class="px-3 py-2 rounded border border-slate-200">↩︎ الرجوع</a>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6">
  <!-- تنبيهات -->
  <div id="notice" class="no-print mb-4 hidden p-3 rounded border text-sm"></div>

  <!-- إعدادات سريعة -->
  <section class="no-print card p-4 mb-4">
    <div class="grid md:grid-cols-4 gap-4">
      <div class="md:col-span-2">
        <label class="block text-sm text-slate-600 mb-1">Control Number</label>
        <input id="singleControl" class="w-full px-3 py-2 border rounded" placeholder="مثال: AS-0001"/>
      </div>

      <div>
        <label class="block text-sm text-slate-600 mb-1">Preset</label>
        <div class="flex gap-2 flex-wrap">
          <button class="px-2 py-1 rounded border" id="presetZebra">Zebra 50×25mm</button>
          <button class="px-2 py-1 rounded border" id="presetBig">A4 عرضي (اختبار)</button>
        </div>
      </div>

      <div>
        <label class="block text-sm text-slate-600 mb-1">طباعة تلقائية</label>
        <select id="autoSel" class="w-full px-3 py-2 border rounded">
          <option value="0" selected>لا</option>
          <option value="1">نعم</option>
        </select>
      </div>
    </div>

    <hr class="my-4">

    <div class="grid md:grid-cols-5 gap-4">
      <div>
        <label class="block text-slate-600 text-sm mb-1">حجم QR (مم)</label>
        <input id="qrMM" type="number" class="w-28 px-2 py-2 border rounded" value="18">
        <div class="text-xs text-slate-500 mt-1">الافتراضي 18mm للمقاس 50×25</div>
      </div>

      <div>
        <label class="block text-slate-600 text-sm mb-1">هوامش داخلية (مم)</label>
        <input id="padMM" type="number" class="w-28 px-2 py-2 border rounded" value="2">
        <div class="text-xs text-slate-500 mt-1">زيرو تقريبًا لزebra، لكن 2mm آمن</div>
      </div>

      <div>
        <label class="block text-slate-600 text-sm mb-1">عنوان أعلى (pt)</label>
        <input id="titlePt" type="number" class="w-24 px-2 py-2 border rounded" value="9">
      </div>

      <div>
        <label class="block text-slate-600 text-sm mb-1">حجم الـControl (pt)</label>
        <input id="ctrlPt" type="number" class="w-24 px-2 py-2 border rounded" value="9">
      </div>

      <div class="flex items-end">
        <button id="apply" class="px-3 py-2 rounded bg-emerald-600 text-white font-bold">تطبيق</button>
      </div>
    </div>

    <div class="mt-3 text-slate-500 text-sm no-print">
      عند الطباعة على تعريف طابعة Zebra من Chrome: اختَر <b>Scale = 100%</b> و <b>Margins = None</b> و <b>Disable Headers/Footers</b>.  
      المقاس مضبوط بـ <code>@page 50mm × 25mm</code> فلا تغيّر حجم الورق من التعريف لو كان يطابق المقاس.
    </div>
  </section>

  <!-- ورقة اللصّاقة -->
  <section id="canvasArea" class="sheet">
    <div class="qr-wrap" id="qrWrap" style="padding:2mm">
      <div id="qrTitle" class="qr-title" style="font-size:9pt; margin-bottom:1mm;">الصيانة الوقائية</div>
      <img id="qrImg" alt="QR" style="width:18mm; height:18mm; display:block;"/>
      <div id="ctrl" class="control-text" style="margin-top:1mm; font-size:9pt;">—</div>
    </div>
  </section>

  <!-- (اختياري) شبكة قسم على ورق عادي -->
  <section id="printArea" class="grid-print hide"></section>
</main>

<script type="module">
  // ==== Helpers UI ====
  const $ = s => document.querySelector(s);
  function notify(msg, type='info'){
    const n = $('#notice');
    n.textContent = msg;
    n.className = 'no-print mb-4 p-3 rounded border text-sm ' + (type==='error' ? 'border-red-300 bg-red-50 text-red-700' :
                                                                 type==='ok'    ? 'border-emerald-300 bg-emerald-50 text-emerald-700' :
                                                                                   'border-sky-300 bg-sky-50 text-sky-700');
    n.hidden = false;
  }
  function clearNotice(){ const n=$('#notice'); n.hidden=true; n.textContent=''; }

  // رابط مطلق لصفحة الاستيكر (لو عندك صفحة معاينة عند المسح)
  function buildStickerLink(control){
    const stickerAbs = new URL('sticker.html', location.href).toString();
    return `${stickerAbs}#view/${encodeURIComponent(control)}`;
  }

  // تحويل مم إلى بكسل (تقريبي ~300dpi => 118px لكل سم => 11.8px لكل مم)
  const mmToPx = (mm)=> Math.round(mm * 11.8);

  async function genQR(text, px=600){
    try{
      // margin=0 علشان أقصى مساحة مرسومة داخل البت ماب
      return await QRCode.toDataURL(text, {width:px, margin:0, errorCorrectionLevel:'M'});
    }catch{
      return 'https://chart.googleapis.com/chart?cht=qr&chs='+px+'x'+px+'&chl='+encodeURIComponent(text);
    }
  }

  // تطبيق الإعدادات على عناصر الورقة
  function applySingleSettings(){
    const padMM   = parseFloat($('#padMM').value||'2');
    const qrMM    = Math.max(10, parseFloat($('#qrMM').value||'18')); // أقل حاجة 10 مم علشان يقرا كويس
    const titlePt = Math.max(6, parseInt($('#titlePt').value||'9',10));
    const ctrlPt  = Math.max(6, parseInt($('#ctrlPt').value ||'9',10));

    $('#qrWrap').style.padding = `${padMM}mm`;
    $('#qrImg').style.width  = `${qrMM}mm`;
    $('#qrImg').style.height = `${qrMM}mm`;
    $('#qrTitle').style.fontSize = `${titlePt}pt`;
    $('#ctrl').style.fontSize    = `${ctrlPt}pt`;
  }

  async function renderSingle(control){
    if(!control){ notify('اكتب رقم Control', 'error'); return; }
    clearNotice();

    // حساب بكسلات الـQR طبقًا للحجم بالمليمتر
    const qrMM = Math.max(10, parseFloat($('#qrMM').value||'18'));
    // ×2 upscaling لحدة أفضل على الحراري
    const px = Math.max(400, mmToPx(qrMM) * 2);

    // محتوى الـQR: رابط يمكن فتحه بعد المسح
    const link = buildStickerLink(control);
    $('#ctrl').textContent = control;
    $('#qrImg').src = await genQR(link, px);
  }

  // Presets
  $('#presetZebra').addEventListener('click', ()=>{
    // مقاس الورقة ثابت بالـ @page (50×25 مم)
    $('#padMM').value   = 2;   // هوامش داخلية بسيطة
    $('#qrMM').value    = 18;  // QR ~18 مم
    $('#titlePt').value = 9;   // عنوان صغير
    $('#ctrlPt').value  = 9;   // كنترول صغير وواضح
    applySingleSettings();
    const c = $('#singleControl').value.trim();
    if(c) renderSingle(c);
    notify('تم تطبيق إعدادات Zebra 50×25mm ✅', 'ok');
  });

  $('#presetBig').addEventListener('click', ()=>{
    // وضع اختبار على A4 (مش للزebra) — بس لتجربة المحتوى بشكل مكبر
    const styleId='__page_size_style__';
    let tag=document.getElementById(styleId);
    if(!tag){ tag=document.createElement('style'); tag.id=styleId; document.head.appendChild(tag); }
    tag.textContent='@page{ size:297mm 210mm; margin:10mm }';

    document.querySelector('.sheet').style.width='120mm';
    document.querySelector('.sheet').style.height='60mm';
    $('#padMM').value=5; $('#qrMM').value=40; $('#titlePt').value=14; $('#ctrlPt').value=14;
    applySingleSettings();
    const c = $('#singleControl').value.trim();
    if(c) renderSingle(c);
    notify('وضع A4 عرضي للاختبار — ليس لطابعة Zebra', 'info');
  });

  // زر تطبيق
  $('#apply').addEventListener('click', ()=>{
    applySingleSettings();
    const c = $('#singleControl').value.trim();
    if(c) renderSingle(c);
  });

  // طباعة
  $('#btnPrint').addEventListener('click', ()=> window.print());

  // تحميل أولي: اضبط إعدادات Zebra
  (function init(){
    // تأكد أن مقاس الصفحة مضبوط دايمًا
    const tag=document.createElement('style');
    tag.textContent='@page{ size:50mm 25mm; margin:0 }';
    document.head.appendChild(tag);

    applySingleSettings();

    // Deep-link: ?control=AS-0001&autoprint=1
    const p = new URLSearchParams(location.search);
    const ctrl = p.get('control');
    const autoprint = p.get('autoprint');
    if (ctrl){
      $('#singleControl').value = decodeURIComponent(ctrl);
      renderSingle($('#singleControl').value).then(()=>{
        if(autoprint==='1'){ setTimeout(()=> window.print(), 300); }
      });
      $('#autoSel').value = autoprint==='1' ? '1' : '0';
    }
  })();
</script>
</body>
</html>
