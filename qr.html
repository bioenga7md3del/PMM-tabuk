
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PM-QR • QR Print</title>
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220;color:#e5e7eb;margin:0}
  .card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:12px;margin:12px;box-shadow:0 12px 36px rgba(0,0,0,.3)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
  .qrBox{background:#fff;color:#000;border-radius:10px;padding:8px;text-align:center}
  .qrBox img{width:100%;height:100%;object-fit:contain}
  .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:12px}
  .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
  .btn1{background:#10b981;color:#083344}
  .btn2{background:#3b82f6;color:#e0f2fe}
  @media print{ .card,.bar{display:none} body{background:#fff;color:#000} }
</style>
</head>
<body>
<div class="bar">
  <input id="site" placeholder="الموقع" />
  <input id="dept" placeholder="القسم" />
  <button class="btn btn2" id="btnLoad">تحميل</button>
  <select id="size">
    <option value="A4" selected>طباعة A4 (افتراضي)</option>
    <option value="6x4">حجم 6سم × 4سم (QR فقط)</option>
  </select>
  <button class="btn btn1" onclick="window.print()">طباعة</button>
</div>
<div id="wrap" class="grid"></div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
const firebaseConfig = {apiKey:"AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",authDomain:"pmqrtabuk.firebaseapp.com",projectId:"pmqrtabuk",storageBucket:"pmqrtabuk.firebasestorage.app",messagingSenderId:"305570616285",appId:"1:305570616285:web:4f6839fd08b8b5aa131c34"};
const app = initializeApp(firebaseConfig); const db = getFirestore(app);
const $ = s=>document.querySelector(s);

function stickerLink(control){ return 'sticker.html#view/'+encodeURIComponent(control); }

async function load(){
  const site = $('#site').value.trim();
  const dept = $('#dept').value.trim();
  const qs = await getDocs(query(collection(db,'assets')));
  let list = qs.docs.map(d=>d.data());
  if(site) list = list.filter(x=> (x.site||'')===site);
  if(dept) list = list.filter(x=> (x.department||'')===dept);

  const small = $('#size').value==='6x4';
  $('#wrap').innerHTML='';
  for(const d of list){
    const link = stickerLink(d.control);
    const box = document.createElement('div');
    box.className='qrBox';
    box.innerHTML = `<div style="font-weight:900;margin-bottom:4px;${small?'font-size:10px':''}">الصيانة الوقائية</div>
    <div><img alt="QR"/></div>
    <div style="margin-top:6px;${small?'font-size:10px':''}">${d.control||''}</div>`;
    const img = box.querySelector('img');
    await QRCode.toDataURL(link, {width: small?120:180, margin: 0}).then(u=> img.src=u);
    $('#wrap').appendChild(box);
  }
}

document.getElementById('btnLoad').onclick = load;
window.addEventListener('load', ()=>{
  const control = new URL(location.href).searchParams.get('control');
  if(control){
    $('#site').value=''; $('#dept').value='';
    $('#wrap').innerHTML='';
    const small = $('#size').value==='6x4';
    const link = stickerLink(control);
    const box = document.createElement('div');
    box.className='qrBox';
    box.innerHTML = `<div style="font-weight:900;margin-bottom:4px;${small?'font-size:10px':''}">الصيانة الوقائية</div>
    <div><img alt="QR"/></div>
    <div style="margin-top:6px;${small?'font-size:10px':''}">${control}</div>`;
    const img = box.querySelector('img');
    QRCode.toDataURL(link, {width: small?120:180, margin: 0}).then(u=> img.src=u);
    $('#wrap').appendChild(box);
  }
});
</script>
</body>
</html>
