<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ø·Ø¨Ø§Ø¹Ø© Ø£ÙƒÙˆØ§Ø¯ QR â€” A4</title>
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
  :root{ --ink:#0f172a; --line:#e5e7eb; }
  body{ background:#f8fafc; color:var(--ink); }
  .card{ background:#fff; border:1px solid var(--line); border-radius:12px; }
  .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }

  .sheet{ margin:16px auto; box-shadow:0 10px 30px rgba(0,0,0,.08); background:#fff; }
  .page{ position:relative; background:#fff; overflow:hidden; page-break-after:always; }
  .grid{ display:grid; page-break-inside:avoid; }

  .label{
    border:1px dashed rgba(15,23,42,.15);
    border-radius:4px;
    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    page-break-inside:avoid;
  }
  .l-ctrl{ font-weight:900; line-height:1.1; text-align:center; }
  .l-title{ font-weight:800; text-align:center; }

  /* âœ… Ø·Ø¨Ø§Ø¹Ø© Ù†Ø¸ÙŠÙØ©: ÙÙ‚Ø· Ø§Ù„Ù€QRs Ù…Ù† Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© */
  @media print{
    @page{ size:A4; margin:0 }
    body{ background:#fff; margin:0; padding:0 }
    .no-print{ display:none !important; }
    .sheet{ margin:0 !important; box-shadow:none !important; }
    .page{ page-break-after:always; }
    .label{ border:0; }
  }
</style>
</head>
<body>
<header class="no-print sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <h1 class="font-extrabold text-lg">Ø·Ø¨Ø§Ø¹Ø© Ø£ÙƒÙˆØ§Ø¯ QR â€” A4</h1>
    <div class="flex items-center gap-2">
      <button id="btnBuild" class="px-3 py-2 rounded bg-emerald-600 text-white font-bold">âš™ï¸ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙØ­Ø§Øª</button>
      <button id="btnPrint" class="px-3 py-2 rounded bg-sky-600 text-white font-bold">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6">
  <!-- Ø¥Ø¯Ø®Ø§Ù„Ø§Øª -->
  <section class="card p-4 mb-4 no-print">
    <label class="block mb-1 text-slate-600 text-sm">Control Numbers (ÙƒÙ„ Ø±Ù‚Ù… ÙÙŠ Ø³Ø·Ø±)</label>
    <textarea id="controls" class="w-full h-32 px-3 py-2 border rounded mono" placeholder="AS-0001&#10;AS-0002"></textarea>
    <div class="mt-3 flex items-center gap-3">
      <label class="flex items-center gap-2 text-sm"><input id="showCtrl" type="checkbox" checked> Ø¥Ø¸Ù‡Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ù€Control</label>
      <label class="flex items-center gap-2 text-sm"><input id="titleOn" type="checkbox" checked> Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† "Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ©"</label>
      <button id="btnBuildNow" class="px-3 py-2 bg-emerald-600 text-white rounded font-bold">ØªØ¬Ù‡ÙŠØ²</button>
    </div>
  </section>

  <!-- Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
  <section id="sheets" class="sheet"></section>
</main>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
const $ = s => document.querySelector(s);
const mm = v => v + 'mm';
const pt = v => v + 'pt';
const mmToPx = mm => Math.round(mm * 11.8);

function buildQRLink(ctrl){
  const base = new URL('sticker.html', location.href).toString();
  return `${base}#view/${encodeURIComponent(ctrl)}`;
}

async function toQR(text, sizePx){
  try{ return await QRCode.toDataURL(text,{width:sizePx,margin:0}); }
  catch{ return 'https://chart.googleapis.com/chart?cht=qr&chs='+sizePx+'x'+sizePx+'&chl='+encodeURIComponent(text); }
}

async function buildSheets(){
  const controls = $('#controls').value.split('\n').map(s=>s.trim()).filter(Boolean);
  if(!controls.length){ alert('Ø£Ø¯Ø®Ù„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªØ­ÙƒÙ…'); return; }

  const showCtrl = $('#showCtrl').checked;
  const showTitle = $('#titleOn').checked;
  const titleText = showTitle ? 'Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ©' : '';
  const labelW = 50, labelH = 25, pad = 2, qrMM = 22;
  const pageW = 210, pageH = 297, margin = 10, gap = 4;
  const cols = Math.floor((pageW - margin*2 + gap) / (labelW + gap));
  const rows = Math.floor((pageH - margin*2 + gap) / (labelH + gap));
  const perPage = cols * rows;

  const sheets = $('#sheets');
  sheets.innerHTML = '';
  sheets.style.width = mm(pageW);
  sheets.style.minHeight = mm(pageH);

  let rest = controls.slice();
  while(rest.length){
    const page = document.createElement('div');
    page.className = 'page';
    page.style.width = mm(pageW);
    page.style.height = mm(pageH);

    const grid = document.createElement('div');
    grid.className = 'grid';
    grid.style.position='absolute';
    grid.style.left = mm(margin);
    grid.style.top = mm(margin);
    grid.style.gridTemplateColumns = `repeat(${cols}, ${mm(labelW)})`;
    grid.style.gridAutoRows = mm(labelH);
    grid.style.gap = mm(gap);

    const slice = rest.slice(0, perPage);
    rest = rest.slice(perPage);
    const pending = [];

    for(const ctrl of slice){
      const lab = document.createElement('div');
      lab.className='label';
      lab.style.width=mm(labelW);
      lab.style.height=mm(labelH);
      lab.style.padding=mm(pad);

      if(showTitle){
        const t=document.createElement('div');
        t.className='l-title';
        t.textContent=titleText;
        t.style.fontSize=pt(10);
        t.style.marginBottom='1mm';
        lab.appendChild(t);
      }

      const img=document.createElement('img');
      img.style.width=mm(qrMM);
      img.style.height=mm(qrMM);
      img.style.display='block';
      img.style.margin='auto';
      lab.appendChild(img);

      if(showCtrl){
        const c=document.createElement('div');
        c.className='l-ctrl mono';
        c.textContent=ctrl;
        c.style.fontSize=pt(9);
        c.style.marginTop='1mm';
        lab.appendChild(c);
      }

      grid.appendChild(lab);

      const link=buildQRLink(ctrl);
      pending.push(toQR(link, Math.max(300, mmToPx(qrMM)*2)).then(u=>img.src=u));
    }

    await Promise.all(pending);
    page.appendChild(grid);
    sheets.appendChild(page);
  }
}

// ØªØ¬Ù‡ÙŠØ² ÙŠØ¯ÙˆÙŠ
$('#btnBuildNow').onclick = buildSheets;

// Ø·Ø¨Ø§Ø¹Ø©
$('#btnPrint').onclick = async ()=>{
  if(!$('#sheets').children.length) await buildSheets();
  const imgs = Array.from($('#sheets').querySelectorAll('img'));
  await Promise.all(imgs.map(img=>img.complete?Promise.resolve():new Promise(r=>{img.onload=r;img.onerror=r;})));
  window.print();
};

// Ù†Ù…ÙˆØ°Ø¬ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¨Ø³ÙŠØ·
$('#controls').value = ['AS-0001','AS-0002','AS-0003','AS-0004','AS-0005','AS-0006'].join('\n');
</script>
</body>
</html>
