<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PM-QR â€” Ø·Ø¨Ø§Ø¹Ø© Ø£ÙƒÙˆØ§Ø¯ QR (Zebra 50Ã—25mm)</title>
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
  :root{ --line:#e5e7eb; --ink:#0f172a; }
  body{background:#f8fafc;color:var(--ink)}
  .card{border:1px solid var(--line);background:#fff;border-radius:10px}
  .hide{display:none!important}

  /* ===== ÙˆØ±Ù‚Ø© Ø§Ù„Ù„ØµÙ‘Ø§Ù‚Ø©: 50Ã—25 Ù…Ù… ===== */
  .sheet{
    background:#fff; color:#000;
    box-shadow:0 10px 30px rgba(0,0,0,.08);
    margin:16px auto; position:relative; overflow:hidden;
    width:50mm; height:25mm;   /* Ø§Ù„Ù…Ù‚Ø§Ø³ Ø§Ù„ÙØ¹Ù„ÙŠ */
  }
  .qr-wrap{
    position:absolute; inset:0; display:flex;
    flex-direction:column; align-items:center; justify-content:center;
  }
  .qr-title{ font-weight:800; text-align:center; line-height:1 }
  .control-text{
    font-weight:900; text-align:center; line-height:1.05;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    letter-spacing: .3px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    max-width: 100%;
  }

  /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (Ù„Ùˆ Ø­Ø¨ÙŠØª ØªØ·Ø¨Ø¹ Ù‚Ø³Ù… Ø¹Ù„Ù‰ ÙˆØ±Ù‚ Ø¹Ø§Ø¯ÙŠ) */
  .qr-card{ width:58mm; padding:6mm; text-align:center; page-break-inside:avoid; border:1px solid var(--line); border-radius:8px; background:#fff }
  .qr-img{ object-fit:contain; display:block; margin:0 auto 6mm auto }
  .qr-control{ font-weight:800; font-size:14px; letter-spacing:.5px }
  .grid-print{ display:grid; grid-template-columns:repeat(3, 1fr); gap:8mm }

  /* Ø·Ø¨Ø§Ø¹Ø© */
  @media print{
    .no-print{display:none !important}
    body{background:#fff}
    .sheet{box-shadow:none;margin:0 auto}
  }
  /* Ù…Ù‚Ø§Ø³ Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
  @page{ size:50mm 25mm; margin:0 }
</style>
</head>
<body>
<header class="no-print sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <h1 class="font-extrabold text-lg">Ø·Ø¨Ø§Ø¹Ø© Ø£ÙƒÙˆØ§Ø¯ QR â€” Zebra 50Ã—25mm</h1>
    <div class="flex items-center gap-2">
      <button id="btnPrint" class="px-3 py-2 rounded bg-sky-600 text-white font-bold">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      <a href="index.html" class="px-3 py-2 rounded border border-slate-200">â†©ï¸ Ø§Ù„Ø±Ø¬ÙˆØ¹</a>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6">
  <!-- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
  <div id="notice" class="no-print mb-4 hidden p-3 rounded border text-sm"></div>

  <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø³Ø±ÙŠØ¹Ø© -->
  <section class="no-print card p-4 mb-4">
    <div class="grid md:grid-cols-4 gap-4">
      <div class="md:col-span-2">
        <label class="block text-sm text-slate-600 mb-1">Control Number</label>
        <input id="singleControl" class="w-full px-3 py-2 border rounded" placeholder="Ù…Ø«Ø§Ù„: AS-0001"/>
      </div>

      <div>
        <label class="block text-sm text-slate-600 mb-1">Preset</label>
        <div class="flex gap-2 flex-wrap">
          <button class="px-2 py-1 rounded border" id="presetZebra">Zebra 50Ã—25mm</button>
          <button class="px-2 py-1 rounded border" id="presetBig">A4 Ø¹Ø±Ø¶ÙŠ (Ø§Ø®ØªØ¨Ø§Ø±)</button>
        </div>
      </div>

      <div>
        <label class="block text-sm text-slate-600 mb-1">Ø·Ø¨Ø§Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</label>
        <select id="autoSel" class="w-full px-3 py-2 border rounded">
          <option value="0" selected>Ù„Ø§</option>
          <option value="1">Ù†Ø¹Ù…</option>
        </select>
      </div>
    </div>

    <hr class="my-4">

    <div class="grid md:grid-cols-5 gap-4">
      <div>
        <label class="block text-slate-600 text-sm mb-1">Ø­Ø¬Ù… QR (Ù…Ù…)</label>
        <input id="qrMM" type="number" class="w-28 px-2 py-2 border rounded" value="18">
        <div class="text-xs text-slate-500 mt-1">Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ 18mm Ù„Ù„Ù…Ù‚Ø§Ø³ 50Ã—25</div>
      </div>

      <div>
        <label class="block text-slate-600 text-sm mb-1">Ù‡ÙˆØ§Ù…Ø´ Ø¯Ø§Ø®Ù„ÙŠØ© (Ù…Ù…)</label>
        <input id="padMM" type="number" class="w-28 px-2 py-2 border rounded" value="2">
        <div class="text-xs text-slate-500 mt-1">Ø²ÙŠØ±Ùˆ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ Ù„Ø²ebraØŒ Ù„ÙƒÙ† 2mm Ø¢Ù…Ù†</div>
      </div>

      <div>
        <label class="block text-slate-600 text-sm mb-1">Ø¹Ù†ÙˆØ§Ù† Ø£Ø¹Ù„Ù‰ (pt)</label>
        <input id="titlePt" type="number" class="w-24 px-2 py-2 border rounded" value="9">
      </div>

      <div>
        <label class="block text-slate-600 text-sm mb-1">Ø­Ø¬Ù… Ø§Ù„Ù€Control (pt)</label>
        <input id="ctrlPt" type="number" class="w-24 px-2 py-2 border rounded" value="9">
      </div>

      <div class="flex items-end">
        <button id="apply" class="px-3 py-2 rounded bg-emerald-600 text-white font-bold">ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
    </div>

    <div class="mt-3 text-slate-500 text-sm no-print">
      Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù„Ù‰ ØªØ¹Ø±ÙŠÙ Ø·Ø§Ø¨Ø¹Ø© Zebra Ù…Ù† Chrome: Ø§Ø®ØªÙØ± <b>Scale = 100%</b> Ùˆ <b>Margins = None</b> Ùˆ <b>Disable Headers/Footers</b>.  
      Ø§Ù„Ù…Ù‚Ø§Ø³ Ù…Ø¶Ø¨ÙˆØ· Ø¨Ù€ <code>@page 50mm Ã— 25mm</code> ÙÙ„Ø§ ØªØºÙŠÙ‘Ø± Ø­Ø¬Ù… Ø§Ù„ÙˆØ±Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø±ÙŠÙ Ù„Ùˆ ÙƒØ§Ù† ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ù‚Ø§Ø³.
    </div>
  </section>

  <!-- ÙˆØ±Ù‚Ø© Ø§Ù„Ù„ØµÙ‘Ø§Ù‚Ø© -->
  <section id="canvasArea" class="sheet">
    <div class="qr-wrap" id="qrWrap" style="padding:2mm">
      <div id="qrTitle" class="qr-title" style="font-size:9pt; margin-bottom:1mm;">Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ©</div>
      <img id="qrImg" alt="QR" style="width:18mm; height:18mm; display:block;"/>
      <div id="ctrl" class="control-text" style="margin-top:1mm; font-size:9pt;">â€”</div>
    </div>
  </section>

  <!-- (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø´Ø¨ÙƒØ© Ù‚Ø³Ù… Ø¹Ù„Ù‰ ÙˆØ±Ù‚ Ø¹Ø§Ø¯ÙŠ -->
  <section id="printArea" class="grid-print hide"></section>
</main>

<script type="module">
  // ==== Helpers UI ====
  const $ = s => document.querySelector(s);
  function notify(msg, type='info'){
    const n = $('#notice');
    n.textContent = msg;
    n.className = 'no-print mb-4 p-3 rounded border text-sm ' + (type==='error' ? 'border-red-300 bg-red-50 text-red-700' :
                                                                 type==='ok'    ? 'border-emerald-300 bg-emerald-50 text-emerald-700' :
                                                                                   'border-sky-300 bg-sky-50 text-sky-700');
    n.hidden = false;
  }
  function clearNotice(){ const n=$('#notice'); n.hidden=true; n.textContent=''; }

  // Ø±Ø§Ø¨Ø· Ù…Ø·Ù„Ù‚ Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ø³ØªÙŠÙƒØ± (Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ ØµÙØ­Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø³Ø­)
  function buildStickerLink(control){
    const stickerAbs = new URL('sticker.html', location.href).toString();
    return `${stickerAbs}#view/${encodeURIComponent(control)}`;
  }

  // ØªØ­ÙˆÙŠÙ„ Ù…Ù… Ø¥Ù„Ù‰ Ø¨ÙƒØ³Ù„ (ØªÙ‚Ø±ÙŠØ¨ÙŠ ~300dpi => 118px Ù„ÙƒÙ„ Ø³Ù… => 11.8px Ù„ÙƒÙ„ Ù…Ù…)
  const mmToPx = (mm)=> Math.round(mm * 11.8);

  async function genQR(text, px=600){
    try{
      // margin=0 Ø¹Ù„Ø´Ø§Ù† Ø£Ù‚ØµÙ‰ Ù…Ø³Ø§Ø­Ø© Ù…Ø±Ø³ÙˆÙ…Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Øª Ù…Ø§Ø¨
      return await QRCode.toDataURL(text, {width:px, margin:0, errorCorrectionLevel:'M'});
    }catch{
      return 'https://chart.googleapis.com/chart?cht=qr&chs='+px+'x'+px+'&chl='+encodeURIComponent(text);
    }
  }

  // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ±Ù‚Ø©
  function applySingleSettings(){
    const padMM   = parseFloat($('#padMM').value||'2');
    const qrMM    = Math.max(10, parseFloat($('#qrMM').value||'18')); // Ø£Ù‚Ù„ Ø­Ø§Ø¬Ø© 10 Ù…Ù… Ø¹Ù„Ø´Ø§Ù† ÙŠÙ‚Ø±Ø§ ÙƒÙˆÙŠØ³
    const titlePt = Math.max(6, parseInt($('#titlePt').value||'9',10));
    const ctrlPt  = Math.max(6, parseInt($('#ctrlPt').value ||'9',10));

    $('#qrWrap').style.padding = `${padMM}mm`;
    $('#qrImg').style.width  = `${qrMM}mm`;
    $('#qrImg').style.height = `${qrMM}mm`;
    $('#qrTitle').style.fontSize = `${titlePt}pt`;
    $('#ctrl').style.fontSize    = `${ctrlPt}pt`;
  }

  async function renderSingle(control){
    if(!control){ notify('Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Control', 'error'); return; }
    clearNotice();

    // Ø­Ø³Ø§Ø¨ Ø¨ÙƒØ³Ù„Ø§Øª Ø§Ù„Ù€QR Ø·Ø¨Ù‚Ù‹Ø§ Ù„Ù„Ø­Ø¬Ù… Ø¨Ø§Ù„Ù…Ù„ÙŠÙ…ØªØ±
    const qrMM = Math.max(10, parseFloat($('#qrMM').value||'18'));
    // Ã—2 upscaling Ù„Ø­Ø¯Ø© Ø£ÙØ¶Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø±Ø§Ø±ÙŠ
    const px = Math.max(400, mmToPx(qrMM) * 2);

    // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù€QR: Ø±Ø§Ø¨Ø· ÙŠÙ…ÙƒÙ† ÙØªØ­Ù‡ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø³Ø­
    const link = buildStickerLink(control);
    $('#ctrl').textContent = control;
    $('#qrImg').src = await genQR(link, px);
  }

  // Presets
  $('#presetZebra').addEventListener('click', ()=>{
    // Ù…Ù‚Ø§Ø³ Ø§Ù„ÙˆØ±Ù‚Ø© Ø«Ø§Ø¨Øª Ø¨Ø§Ù„Ù€ @page (50Ã—25 Ù…Ù…)
    $('#padMM').value   = 2;   // Ù‡ÙˆØ§Ù…Ø´ Ø¯Ø§Ø®Ù„ÙŠØ© Ø¨Ø³ÙŠØ·Ø©
    $('#qrMM').value    = 18;  // QR ~18 Ù…Ù…
    $('#titlePt').value = 9;   // Ø¹Ù†ÙˆØ§Ù† ØµØºÙŠØ±
    $('#ctrlPt').value  = 9;   // ÙƒÙ†ØªØ±ÙˆÙ„ ØµØºÙŠØ± ÙˆÙˆØ§Ø¶Ø­
    applySingleSettings();
    const c = $('#singleControl').value.trim();
    if(c) renderSingle(c);
    notify('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Zebra 50Ã—25mm âœ…', 'ok');
  });

  $('#presetBig').addEventListener('click', ()=>{
    // ÙˆØ¶Ø¹ Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù„Ù‰ A4 (Ù…Ø´ Ù„Ù„Ø²ebra) â€” Ø¨Ø³ Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø´ÙƒÙ„ Ù…ÙƒØ¨Ø±
    const styleId='__page_size_style__';
    let tag=document.getElementById(styleId);
    if(!tag){ tag=document.createElement('style'); tag.id=styleId; document.head.appendChild(tag); }
    tag.textContent='@page{ size:297mm 210mm; margin:10mm }';

    document.querySelector('.sheet').style.width='120mm';
    document.querySelector('.sheet').style.height='60mm';
    $('#padMM').value=5; $('#qrMM').value=40; $('#titlePt').value=14; $('#ctrlPt').value=14;
    applySingleSettings();
    const c = $('#singleControl').value.trim();
    if(c) renderSingle(c);
    notify('ÙˆØ¶Ø¹ A4 Ø¹Ø±Ø¶ÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± â€” Ù„ÙŠØ³ Ù„Ø·Ø§Ø¨Ø¹Ø© Zebra', 'info');
  });

  // Ø²Ø± ØªØ·Ø¨ÙŠÙ‚
  $('#apply').addEventListener('click', ()=>{
    applySingleSettings();
    const c = $('#singleControl').value.trim();
    if(c) renderSingle(c);
  });

  // Ø·Ø¨Ø§Ø¹Ø©
  $('#btnPrint').addEventListener('click', ()=> window.print());

  // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ: Ø§Ø¶Ø¨Ø· Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Zebra
  (function init(){
    // ØªØ£ÙƒØ¯ Ø£Ù† Ù…Ù‚Ø§Ø³ Ø§Ù„ØµÙØ­Ø© Ù…Ø¶Ø¨ÙˆØ· Ø¯Ø§ÙŠÙ…Ù‹Ø§
    const tag=document.createElement('style');
    tag.textContent='@page{ size:50mm 25mm; margin:0 }';
    document.head.appendChild(tag);

    applySingleSettings();

    // Deep-link: ?control=AS-0001&autoprint=1
    const p = new URLSearchParams(location.search);
    const ctrl = p.get('control');
    const autoprint = p.get('autoprint');
    if (ctrl){
      $('#singleControl').value = decodeURIComponent(ctrl);
      renderSingle($('#singleControl').value).then(()=>{
        if(autoprint==='1'){ setTimeout(()=> window.print(), 300); }
      });
      $('#autoSel').value = autoprint==='1' ? '1' : '0';
    }
  })();
</script>
</body>
</html>
