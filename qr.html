<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>توليد QR</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:#0b1220;color:#e5e7eb}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;box-shadow:0 12px 36px rgba(0,0,0,.3)}
    .qrbox{width:240px;height:240px;background:#fff;border-radius:10px;display:flex;align-items:center;justify-content:center}
    .notice{position:sticky;top:0;padding:8px 12px;text-align:center;font-weight:700}
    .n-info{background:#1f2937;color:#93c5fd}
    .n-ok{background:#062e18;color:#a7f3d0}
    .n-err{background:#3a0d0d;color:#fecaca}
    input{background:#0b1220;border:1px solid #374151;border-radius:10px;padding:10px 12px;color:#fff}
    a.link{color:#67e8f9;word-break:break-all}
  </style>
</head>
<body class="min-h-screen">
  <div id="notice" class="notice n-info">اكتب الكنترول نمبر أو افتح الصفحة من زر QR داخل الجدول.</div>

  <main class="max-w-4xl mx-auto p-4">
    <div class="card p-5">
      <h1 class="text-2xl font-extrabold mb-4">توليد كود QR</h1>

      <div class="flex gap-3 items-center mb-4 flex-wrap">
        <label class="text-slate-300">Control Number</label>
        <input id="control" placeholder="AS-0001 (مثال)" class="min-w-[260px]"/>
        <button id="btnGen"  class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 font-bold">توليد</button>
        <button id="btnClear"class="px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-500 font-bold">مسح</button>
      </div>

      <div class="flex gap-5 items-start flex-wrap">
        <div class="qrbox"><img id="qrImg" alt="QR" /></div>
        <div class="grow">
          <div class="mb-2 text-slate-300">رابط المسح (يفتح الاستيكر مباشرة):</div>
          <a id="qrLink" class="link" target="_blank"></a>
          <div class="mt-4 flex gap-3">
            <button id="btnCopy"  class="px-3 py-2 rounded bg-sky-600 hover:bg-sky-500 font-bold">نسخ الرابط</button>
            <button id="btnPrint" class="px-3 py-2 rounded bg-sky-700 hover:bg-sky-600 font-bold">طباعة</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- مكتبة توليد الـ QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script>
    const $ = s => document.querySelector(s);
    const notice = (m,t='info')=>{
      const n=$('#notice');
      n.textContent=m;
      n.className = 'notice ' + (t==='ok'?'n-ok':t==='error'?'n-err':'n-info');
    };

    // يبني رابط الاستيكر من الكونترول
    function stickerURL(control){
      const base = location.origin + location.pathname.replace(/[^\/]+$/,''); // مجلد الموقع الحالي
      // لو ملفك اسمه sticker.html وموجود بجوار qr.html:
      return base + 'sticker.html#view/' + encodeURIComponent(control);
    }

    async function generate(){
      const control = $('#control').value.trim();
      if(!control){ notice('اكتب الكنترول نمبر','error'); return; }
      const link = stickerURL(control);

      // توليد صورة QR محليًا
      try{
        const dataUrl = await QRCode.toDataURL(link, { width: 240, margin: 1 });
        $('#qrImg').src = dataUrl;
        $('#qrLink').href = link;
        $('#qrLink').textContent = link;
        notice('تم توليد الـ QR والرابط بنجاح ✅','ok');
      }catch(e){
        notice('فشل توليد الـ QR: '+(e.message||''),'error');
        console.error(e);
      }
    }

    // أزرار
    $('#btnGen').onclick = generate;
    $('#btnClear').onclick = ()=>{
      $('#control').value='';
      $('#qrImg').src='';
      $('#qrLink').textContent='';
      $('#qrLink').href='';
      notice('تم المسح.','info');
    };
    $('#btnCopy').onclick = async ()=>{
      if(!$('#qrLink').href){ notice('لا يوجد رابط لنسخه','error'); return; }
      try{ await navigator.clipboard.writeText($('#qrLink').href);
           notice('تم نسخ الرابط ✅','ok'); }catch{ notice('تعذر النسخ','error'); }
    };

    // طباعة الـ QR في نافذة صغيرة
    $('#btnPrint').onclick = ()=>{
      const img = $('#qrImg').src;
      const link = $('#qrLink').href;
      const ctrl = $('#control').value.trim();

      const w = window.open('', '_blank', 'width=480,height=520');
      w.document.write(`<!doctype html>
<html lang="ar"><head><meta charset="utf-8"/>
  <title>QR • ${ctrl}</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#fff}
    .box{border:1px solid #ddd;border-radius:12px;padding:16px 18px;text-align:center}
    img{width:260px;height:260px}
    a{display:block;margin-top:10px;word-break:break-all;color:#0ea5e9;text-decoration:none}
    .c{margin-bottom:8px;font-weight:700}
  </style>
</head><body>
  <div class="box">
    <div class="c">${ctrl}</div>
    <img src="${img}" alt="QR"/>
    <a href="${link}" target="_blank">${link}</a>
  </div>
  <script>window.print();<\/script>
</body></html>`);
      w.document.close();
    };

    // قراءة الكنترول من الـ URL والهاش وتوليد تلقائي
    (function initFromURL(){
      const qs = new URLSearchParams(location.search);
      let control = qs.get('control');
      if(!control){
        const m = (location.hash||'').match(/control=([^&]+)/i);
        if(m) control = decodeURIComponent(m[1]);
      }
      if(control){
        $('#control').value = control;
        generate();
      }else{
        notice('اكتب الكنترول نمبر أو افتح من زر QR داخل الجدول.','info');
      }
    })();

    // Enter shortcut
    $('#control').addEventListener('keydown',e=>{ if(e.key==='Enter') generate(); });
  </script>
</body>
</html>
