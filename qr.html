<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>توليد QR</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
  body{background:#0b1220;color:#e5e7eb}
  .card{background:#111827;border:1px solid #1f2937;border-radius:14px;box-shadow:0 14px 36px rgba(0,0,0,.35)}
  .input{width:100%;padding:.9rem 1rem;border-radius:12px;border:1px solid #374151;background:#0b1220;color:#fff}
  .btn{padding:.8rem 1rem;border-radius:12px;font-weight:800}
  .btn-main{background:#10b981;color:#062e2a}
  .btn-sec{background:#3b82f6;color:#e0f2fe}
  .qr{width:240px;height:240px;background:#fff;border-radius:10px;display:flex;align-items:center;justify-content:center}
  .notice{position:sticky;top:0;text-align:center;font-weight:800;padding:.5rem 1rem}
  .n-ok{background:rgba(16,185,129,.15);border-bottom:1px solid rgba(16,185,129,.45);color:#86efac}
  .n-err{background:rgba(239,68,68,.15);border-bottom:1px solid rgba(239,68,68,.45);color:#fecaca}
  .n-info{background:rgba(59,130,246,.15);border-bottom:1px solid rgba(59,130,246,.45);color:#bfdbfe}
  a.link{color:#67e8f9;word-break:break-all}
</style>
</head>
<body class="min-h-screen">
<div id="notice" class="notice n-info">أدخل الكنترول نمبر أو افتح الصفحة من زر QR في الجدول…</div>

<main class="max-w-3xl mx-auto p-4">
  <div class="card p-5">
    <h1 class="text-2xl font-extrabold mb-4">توليد كود QR</h1>
    <div class="grid md:grid-cols-[1fr_auto_auto] gap-3 items-end">
      <div>
        <label class="block mb-2 text-slate-300">Control Number</label>
        <input id="control" class="input" placeholder="(مثال: AS-0001)"/>
      </div>
      <button id="btnGen" class="btn btn-main">توليد</button>
      <button id="btnClear" class="btn btn-sec">مسح</button>
    </div>

    <div class="mt-5 grid md:grid-cols-[240px_1fr] gap-4 items-start">
      <div class="qr"><img id="qrImg" alt="QR"/></div>
      <div>
        <div class="mb-2 text-slate-400">رابط المسح (يفتح الاستيكر):</div>
        <a id="qrLink" class="link" target="_blank"></a>
        <div class="mt-4 flex gap-3">
          <button id="btnPrint" class="btn btn-sec">طباعة QR</button>
          <button id="btnCopy"  class="btn btn-sec">نسخ الرابط</button>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
const $ = s => document.querySelector(s);
const notice = (m,t='info')=>{
  const n=$('#notice'); n.textContent=m;
  n.className='notice '+(t==='ok'?'n-ok':t==='error'?'n-err':'n-info');
};

// يبني رابط الاستيكر
function stickerLink(control){
  const base = location.origin + location.pathname.replace(/[^\/]+$/,''); // مسار المجلد الحالي
  return base + 'sticker.html#view/' + encodeURIComponent(control);
}

// توليد QR محليًا
function renderQR(text){
  const img = $('#qrImg');
  QRCode.toDataURL(text,{width:240,margin:1})
    .then(url=> img.src=url)
    .catch(()=> img.src='https://chart.googleapis.com/chart?cht=qr&chs=240x240&chl='+encodeURIComponent(text));
}

// إجراء التوليد
function generate(){
  const control = $('#control').value.trim();
  if(!control){ notice('اكتب الكنترول نمبر أولاً','error'); return; }
  const link = stickerLink(control);
  $('#qrLink').textContent = link;
  $('#qrLink').href = link;
  renderQR(link);
  notice('تم توليد QR ورابط الاستيكر ✅','ok');
}

// تفريغ
function clearAll(){
  $('#control').value='';
  $('#qrImg').src='';
  $('#qrLink').textContent='';
  $('#qrLink').href='';
  notice('تم المسح','info');
}

$('#btnGen').onclick = generate;
$('#btnClear').onclick = clearAll;
$('#btnCopy').onclick = async ()=>{
  const t=$('#qrLink').href; if(!t) return;
  try{ await navigator.clipboard.writeText(t); notice('تم نسخ الرابط ✅','ok'); }catch{}
};
$('#btnPrint').onclick = ()=>{
  const w=window.open('','_blank','width=480,height=520');
  const img = $('#qrImg').src, link=$('#qrLink').href, ctrl=$('#control').value.trim();
  w.document.write(`<!doctype html><html lang="ar"><head><meta charset="utf-8"/>
  <title>QR • ${ctrl}</title><style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
  .box{border:1px solid #ddd;border-radius:12px;padding:16px;text-align:center}
  img{width:260px;height:260px}
  a{display:block;margin-top:8px;word-break:break-all;color:#0ea5e9;text-decoration:none}
  </style></head><body>
  <div class="box">
    <div><b>${ctrl}</b></div>
    <img src="${img}" alt="QR"/>
    <a href="${link}" target="_blank">${link}</a>
  </div>
  <script>window.print()</script>
  </body></html>`);
  w.document.close();
};

// ===== قراءة الكنترول من URL والهاش وتوليد تلقائي =====
(function initFromURL(){
  const qs = new URLSearchParams(location.search);
  // أولوية لباراميتر ?control= ، وإلا جرّب #control=<value>
  let control = qs.get('control');
  if(!control){
    const m = (location.hash||'').match(/control=([^&]+)/i);
    if(m) control = decodeURIComponent(m[1]);
  }
  if(control){
    $('#control').value = control;
    generate(); // توليد تلقائي
  }else{
    notice('اكتب الكنترول نمبر أو افتح من زر QR داخل الجدول.','info');
  }
})();
</script>
</body>
</html>
