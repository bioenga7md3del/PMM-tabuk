<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PPM TABUK – Login</title>
<style>
  :root{
    --bg:#0b1220;--panel:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;
    --ok:#10b981;--info:#3b82f6;--line:#1f2937;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;min-height:100vh;display:grid;place-items:center}
  .shell{width:min(1020px,95vw);display:grid;grid-template-columns:1fr 1fr;gap:0;border-radius:16px;overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,.45)}
  /* left banner */
  .banner{
    background:linear-gradient(165deg,#1d4ed8 0%,#0ea5e9 55%,#5eead4 120%);
    display:grid;place-items:center;padding:28px;
  }
  .banner .inner{max-width:420px;text-align:center}
  .logos{display:flex;gap:16px;align-items:center;justify-content:center;margin:14px 0 6px}
  .logos img{height:64px;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,.25))}
  .w1{font-size:28px;font-weight:900;margin:6px 0 6px}
  .w2{font-size:16px;font-weight:600;opacity:.95}

  /* right form */
  .panel{background:var(--card);border-left:1px solid var(--line);padding:26px 26px 30px;display:grid;align-content:center}
  .title{font-size:22px;font-weight:800;margin-bottom:8px}
  .sub{color:var(--muted);margin-bottom:22px}
  label{display:block;font-weight:700;margin:10px 4px 6px}
  input, select{
    width:100%;padding:12px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#fff;
  }
  input::placeholder{color:#6b7280}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:18px}
  .btn{padding:12px;border:0;border-radius:10px;font-weight:800;cursor:pointer}
  .primary{background:var(--ok);color:#064e3b}
  .secondary{background:var(--info);color:#dbeafe}
  .link{display:inline-block;margin-top:10px;color:#93c5fd;text-decoration:none}
  .msg{margin-top:14px;color:#fcd34d}
  .foot{margin-top:18px;color:#64748b;font-size:12px}

  /* responsive: stack */
  @media (max-width:900px){
    .shell{grid-template-columns:1fr}
    .banner{display:none}
  }
</style>
</head>
<body>
  <div class="shell">
    <!-- Left banner -->
    <aside class="banner">
      <div class="inner">
        <div class="logos">
          <img src="assets/FGC.jpeg" alt="FGC"/>
          <img src="assets/TabukCluster.jpeg" alt="Tabuk"/>
        </div>
        <div class="w1">Welcome to PPM TABUK</div>
        <div class="w2">إدارة الصيانة – قسم الأجهزة الطبية</div>
      </div>
    </aside>

    <!-- Right form -->
    <main class="panel">
      <div class="title">تسجيل الدخول</div>
      <div class="sub">ادخل بريدك الإلكتروني وكلمة المرور.</div>

      <label for="email">البريد الإلكتروني</label>
      <input id="email" type="email" placeholder="name@example.com"/>

      <label for="password">كلمة المرور</label>
      <input id="password" type="password" placeholder="••••••••"/>

      <a class="link" href="#" id="forgot">نسيت كلمة المرور؟</a>

      <div class="actions">
        <button class="btn primary" id="loginBtn">تسجيل الدخول</button>
        <button class="btn secondary" id="registerBtn">إضافة مستخدم جديد</button>
      </div>

      <!-- اختيار الدور عند الإنشاء فقط (افتراضي Technician) -->
      <div class="row" style="margin-top:12px">
        <div>
          <label for="name">الاسم (عند إضافة مستخدم)</label>
          <input id="name" type="text" placeholder="الاسم الكامل"/>
        </div>
        <div>
          <label for="role">الدور (عند إضافة مستخدم)</label>
          <select id="role">
            <option value="technician" selected>Technician</option>
            <option value="engineer">Engineer</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>

      <div id="msg" class="msg"></div>
      <div class="foot">PPM TABUK © 2025</div>
    </main>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyDegk1oK0xV8TgrZcwbkRLA2VgzkGK_1MM",
  authDomain:"pmqrtabuk.firebaseapp.com",
  projectId:"pmqrtabuk",
  storageBucket:"pmqrtabuk.firebasestorage.app",
  messagingSenderId:"305570616285",
  appId:"1:305570616285:web:4f6839fd08b8b5aa131c34"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const $ = id=>document.getElementById(id);
const msg = t => ($('msg').textContent=t);

$('loginBtn').onclick = async ()=>{
  try{
    const email=$('email').value.trim(), pass=$('password').value.trim();
    if(!email||!pass) return msg('من فضلك أدخل البريد وكلمة المرور');
    await signInWithEmailAndPassword(auth,email,pass);

    // لو مفيش مستند للمستخدم، أنشئه بشكل خفيف (أول مرة)
    const uid = auth.currentUser.uid;
    const uref = doc(db,'users',uid);
    const snap = await getDoc(uref);
    if(!snap.exists()){
      await setDoc(uref,{ email, role:'technician', createdAt:new Date().toISOString() });
    }
    msg('تم تسجيل الدخول ✅');
    setTimeout(()=>location.href='index.html',700);
  }catch(e){ msg('خطأ: '+e.message); }
};

$('registerBtn').onclick = async ()=>{
  try{
    const email=$('email').value.trim(), pass=$('password').value.trim();
    const name=$('name').value.trim();
    const role=$('role').value;
    if(!email||!pass) return msg('من فضلك أدخل البريد وكلمة المرور (والاسم اختياري).');

    const cred = await createUserWithEmailAndPassword(auth,email,pass);
    await setDoc(doc(db,'users',cred.user.uid),{
      email, name: name||'', role, allowedSites:[], allowedDepartments:[],
      createdAt:new Date().toISOString()
    });
    msg('تم إنشاء المستخدم في Authentication + Firestore ✅');
  }catch(e){ msg('خطأ: '+e.message); }
};

$('forgot').onclick = async (e)=>{
  e.preventDefault();
  try{
    const email=$('email').value.trim();
    if(!email) return msg('اكتب بريدك ثم اضغط نسيت كلمة المرور');
    await sendPasswordResetEmail(auth,email);
    msg('تم إرسال رابط استعادة كلمة المرور إلى بريدك ✅');
  }catch(e){ msg('خطأ: '+e.message); }
};
</script>
</body>
</html>
